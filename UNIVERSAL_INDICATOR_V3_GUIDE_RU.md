# Универсальный Индикатор v3 - Fibonacci Overlay

## Описание

Индикатор `universal_indicator_v3_overlay.pine` является улучшенной версией v2, которая корректно строит уровни Фибоначчи с использованием **логарифмической шкалы**.

## Ключевые улучшения

### 1. Логарифмическая шкала Фибоначчи

В отличие от v2, который использовал линейную шкалу, v3 использует логарифмическую шкалу для более точного определения уровней на волатильных рынках.

**Формула:**
```
Price = exp(log(High) - (log(High) - log(Low)) * level)
```

### 2. Правильное построение уровней

- **Для зелёной свечи (бычий сигнал):** Фибоначчи строится от Low до High
- **Для красной свечи (медвежий сигнал):** Фибоначчи строится от High до Low

### 3. Торговые уровни

Индикатор использует следующие уровни Фибоначчи:

| Уровень | Значение | Назначение | Действие |
|---------|----------|------------|----------|
| TP3 | -261.8% | Take Profit 3 | Закрыть 40% позиции |
| TP2 | -161.8% | Take Profit 2 | Закрыть 30% позиции |
| TP1 | -61.8% | Take Profit 1 | Закрыть 30% позиции |
| Entry #1 | 0% | Вход №1 | 1% депозита (рыночный ордер) |
| Entry #2 | 50% | Вход №2 | 1% депозита (лимитный ордер) |
| Entry #3 | 61.8% | Вход №3 | 1% депозита (лимитный ордер) |
| STOP-LOSS | 82% | Стоп-лосс | Всегда на уровне 0.82 |
| Base | 100% | Основание | Low свечи |

### 4. Визуальные элементы

#### Цветовая схема линий:

- **TP3:** Яркий зелёный (#00FF00) - самая высокая цель
- **TP2:** Зелёный (#00CC00) - средняя цель
- **TP1:** Тёмно-зелёный (#009900) - первая цель
- **Entry #1:** Оранжевый (#FF6600) - основной вход на High свечи
- **Entry #2:** Жёлтый (#FFFF00) - дополнительный вход
- **Entry #3:** Золотой (#FFD700) - золотое сечение
- **STOP-LOSS:** Красный (#FF0000) - уровень стоп-лосса
- **Base:** Синий (#0066FF) - основание на Low свечи

#### Таблица значений

Справа вверху отображается таблица с:
- Названием уровня
- Точной ценой
- Торговым действием

Цвета в таблице полностью соответствуют цветам линий на графике.

## Использование

### Установка

1. Откройте TradingView
2. Нажмите Pine Editor
3. Скопируйте содержимое `indicators/universal_indicator_v3_overlay.pine`
4. Добавьте индикатор на график

### Настройки

#### RSI Settings (должны совпадать с основным индикатором):
- **RSI Length:** Период RSI (по умолчанию: 14)
- **RSI Smoothing:** Сглаживание RSI (по умолчанию: 3)
- **Oversold Level:** Уровень перепроданности (по умолчанию: 30)
- **Overbought Level:** Уровень перекупленности (по умолчанию: 70)

#### Momentum Settings (должны совпадать с основным индикатором):
- **Volume MA Length:** Период MA объема (по умолчанию: 20)
- **Momentum Threshold:** Порог моментума (по умолчанию: 1.2)
- **Min Bars Between Signals:** Минимум баров между сигналами (по умолчанию: 10)

#### Fibonacci Settings:
- **Show Bullish Fibonacci:** Показать бычьи уровни
- **Show Bearish Fibonacci:** Показать медвежьи уровни
- **Show Level Labels:** Показать метки уровней
- **Show Levels Table:** Показать таблицу уровней
- **Line Extension:** Продление линий вправо (по умолчанию: 10 свечей)

#### Display Settings:
- **Show Bullish Candle Markers:** Показать бычьи маркеры
- **Show Bearish Candle Markers:** Показать медвежьи маркеры
- **Highlight Signal Candles:** Подсветить сигнальные свечи

## Торговая стратегия

### Для бычьего сигнала (зелёная свеча):

1. **Входы:**
   - Entry #1 (0%): Основной вход по рыночной цене на High сигнальной свечи - 1% депозита
   - Entry #2 (50%): Лимитный ордер на 50% уровне - 1% депозита
   - Entry #3 (61.8%): Лимитный ордер на золотом сечении - 1% депозита

2. **Стоп-лосс:**
   - STOP-LOSS (82%): Установить стоп-лосс на уровне 82%

3. **Фиксация прибыли:**
   - TP1 (-61.8%): Закрыть 30% позиции
   - TP2 (-161.8%): Закрыть 30% позиции
   - TP3 (-261.8%): Закрыть оставшиеся 40% позиции

### Для медвежьего сигнала (красная свеча):

Аналогично, но в обратном направлении:
- Entry #1 на High свечи (короткая позиция)
- Стоп-лосс выше High
- Цели прибыли ниже Low

## Математическое обоснование

### Логарифмическая шкала vs Линейная шкала

**Линейная шкала (v2):**
```
Price = High - (High - Low) * level
```

**Логарифмическая шкала (v3):**
```
Price = exp(log(High) - (log(High) - log(Low)) * level)
```

### Преимущества логарифмической шкалы:

1. **Пропорциональные изменения:** Логарифмическая шкала учитывает процентные изменения, а не абсолютные
2. **Лучше для волатильных рынков:** Особенно важно для криптовалют и акций с высокой волатильностью
3. **Визуальная согласованность:** При использовании логарифмической шкалы графика уровни выглядят естественно

### Пример расчёта:

Допустим, сигнальная свеча имеет:
- Low = 100
- High = 110

**Линейная шкала:**
- Entry #1 (0%): 110.00
- Entry #2 (50%): 105.00
- STOP-LOSS (82%): 101.80
- Base (100%): 100.00

**Логарифмическая шкала:**
- Entry #1 (0%): 110.00
- Entry #2 (50%): 104.88 (≈ geometric mean)
- STOP-LOSS (82%): 101.95
- Base (100%): 100.00

Разница становится более значительной при большем диапазоне цен.

## Тестирование

В папке `experiments/` находится тестовый индикатор `universal_indicator_v3_test.pine`, который позволяет:
- Сравнить логарифмические и линейные расчёты
- Визуализировать уровни на произвольных значениях Low/High
- Проверить точность вычислений

## Отличия от v2

| Особенность | v2 | v3 |
|-------------|----|----|
| Шкала Фибоначчи | Линейная | Логарифмическая |
| Построение для бычьих | От swing low/high | От Low/High сигнальной свечи |
| Построение для медвежьих | От swing low/high | От High/Low сигнальной свечи |
| Торговые уровни | Стандартные Фибоначчи | Кастомные торговые уровни |
| Таблица значений | Нет | Да, с цветами и аннотациями |
| Аннотации | Базовые | Детальные с торговыми действиями |

## Алерты

Индикатор поддерживает два типа алертов:
1. **Bullish Fibonacci Signal:** Бычий сигнал с построенными уровнями Фибоначчи
2. **Bearish Fibonacci Signal:** Медвежий сигнал с построенными уровнями Фибоначчи

## Рекомендации

1. **Используйте совместно с основным индикатором:** Universal Indicator v2 (основной, overlay=false)
2. **Убедитесь в совпадении настроек:** RSI и Momentum параметры должны совпадать
3. **Учитывайте волатильность:** Логарифмическая шкала особенно важна на волатильных рынках
4. **Следуйте торговому плану:** Используйте все три входа и уровни фиксации прибыли
5. **Не забывайте про стоп-лосс:** Всегда устанавливайте стоп-лосс на уровне 82%

## Лицензия

Mozilla Public License 2.0

© TRADERAGENT
