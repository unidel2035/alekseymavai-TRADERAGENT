// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TRADERAGENT

//@version=6
indicator("Universal Indicator", overlay=false, max_lines_count=500)

// ============================================================================
// INPUTS
// ============================================================================

// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI Settings")
rsiSmoothLength = input.int(3, "RSI Smoothing Length", minval=1, group="RSI Settings")
rsiOversold = input.int(30, "RSI Oversold Level", minval=1, maxval=50, group="RSI Settings")
rsiOverbought = input.int(70, "RSI Overbought Level", minval=50, maxval=100, group="RSI Settings")

// Volume-Momentum Settings
volumeMaLength = input.int(20, "Volume MA Length", minval=1, group="Momentum Settings")
momentumThreshold = input.float(1.2, "Momentum Threshold", minval=1.0, step=0.1, group="Momentum Settings")

// Fibonacci Settings
fibLookback = input.int(100, "Fibonacci Lookback Period", minval=10, group="Fibonacci Settings")
showFibLevels = input.bool(true, "Show Fibonacci Levels on Chart", group="Fibonacci Settings")

// Display Settings
showBullishSignals = input.bool(true, "Show Bullish Signals", group="Display Settings")
showBearishSignals = input.bool(true, "Show Bearish Signals", group="Display Settings")
showZones = input.bool(true, "Show Colored Zones", group="Display Settings")

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

// RSI Calculation
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// Volume Momentum (normalized volume relative to its moving average)
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa

// State Detection
isOversold = rsi < rsiOversold
isOverbought = rsi > rsiOverbought
isNeutral = not isOversold and not isOverbought

// Momentum Confirmation
strongMomentum = volumeMomentum > momentumThreshold

// ============================================================================
// SIGNAL DETECTION LOGIC
// ============================================================================

// Bullish Signal: Transition from oversold with momentum
// - RSI crosses above oversold level
// - Volume momentum is strong
// - RSI smooth is rising
bullishTransition = ta.crossover(rsi, rsiOversold)
rsiRising = rsiSmooth > rsiSmooth[1]
bullishSignal = bullishTransition and strongMomentum and rsiRising

// Bearish Signal: Transition from overbought with momentum
// - RSI crosses below overbought level
// - Volume momentum is strong
// - RSI smooth is falling
bearishTransition = ta.crossunder(rsi, rsiOverbought)
rsiFalling = rsiSmooth < rsiSmooth[1]
bearishSignal = bearishTransition and strongMomentum and rsiFalling

// Track signals for Fibonacci drawing
var int lastBullishBar = na
var int lastBearishBar = na
var float lastBullishLow = na
var float lastBullishHigh = na
var float lastBearishLow = na
var float lastBearishHigh = na

if bullishSignal
    lastBullishBar := bar_index
    // Find swing points in lookback period
    lastBullishLow := ta.lowest(low, fibLookback)
    lastBullishHigh := ta.highest(high, fibLookback)

if bearishSignal
    lastBearishBar := bar_index
    // Find swing points in lookback period
    lastBearishLow := ta.lowest(low, fibLookback)
    lastBearishHigh := ta.highest(high, fibLookback)

// ============================================================================
// FIBONACCI LEVELS CALCULATION
// ============================================================================

// Bullish Fibonacci Levels (from low to high)
bullishFibRange = not na(lastBullishHigh) and not na(lastBullishLow) ? lastBullishHigh - lastBullishLow : 0.0
bullishFib0 = not na(lastBullishLow) ? lastBullishLow : 0.0
bullishFib236 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.236 : 0.0
bullishFib382 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.382 : 0.0
bullishFib50 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.500 : 0.0
bullishFib618 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.618 : 0.0
bullishFib786 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.786 : 0.0
bullishFib100 = not na(lastBullishHigh) ? lastBullishHigh : 0.0

// Bearish Fibonacci Levels (from high to low)
bearishFibRange = not na(lastBearishHigh) and not na(lastBearishLow) ? lastBearishHigh - lastBearishLow : 0.0
bearishFib0 = not na(lastBearishHigh) ? lastBearishHigh : 0.0
bearishFib236 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.236 : 0.0
bearishFib382 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.382 : 0.0
bearishFib50 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.500 : 0.0
bearishFib618 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.618 : 0.0
bearishFib786 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.786 : 0.0
bearishFib100 = not na(lastBearishLow) ? lastBearishLow : 0.0

// ============================================================================
// VISUALIZATION - INDICATOR PANEL
// ============================================================================

// Plot RSI
plot(rsi, "RSI", color=color.blue, linewidth=2)
plot(rsiSmooth, "RSI Smooth", color=color.orange, linewidth=1)

// Plot levels
hline(rsiOversold, "Oversold", color=color.green, linestyle=hline.style_dashed)
hline(50, "Midline", color=color.gray, linestyle=hline.style_dotted)
hline(rsiOverbought, "Overbought", color=color.red, linestyle=hline.style_dashed)

// Colored zones
oversoldZoneColor = showZones and isOversold ? color.new(color.green, 80) : na
overboughtZoneColor = showZones and isOverbought ? color.new(color.red, 80) : na

bgcolor(oversoldZoneColor, title="Oversold Zone")
bgcolor(overboughtZoneColor, title="Overbought Zone")

// Plot Volume Momentum as histogram
volumeMomentumScaled = (volumeMomentum - 1) * 50 + 50  // Scale to RSI range
plot(volumeMomentumScaled, "Volume Momentum", style=plot.style_histogram,
     color=volumeMomentum > momentumThreshold ? color.new(color.green, 50) : color.new(color.gray, 70))

// Signal markers on indicator panel
plotshape(showBullishSignals and bullishSignal, "Bullish Signal Marker",
         location=location.bottom, color=color.new(color.green, 0),
         style=shape.triangleup, size=size.small)

plotshape(showBearishSignals and bearishSignal, "Bearish Signal Marker",
         location=location.top, color=color.new(color.red, 0),
         style=shape.triangledown, size=size.small)

// ============================================================================
// VISUALIZATION - FIBONACCI LEVELS ON CHART (OVERLAY)
// ============================================================================

// Note: Since this indicator has overlay=false, we'll use plotchar to mark
// the price chart indirectly. For full Fibonacci visualization, users should
// add the companion overlay indicator or use the alert system.

// ============================================================================
// ALERTS
// ============================================================================

// Alert conditions
alertcondition(bullishSignal, "Bullish Signal", "Universal Indicator: Bullish reversal signal detected!")
alertcondition(bearishSignal, "Bearish Signal", "Universal Indicator: Bearish reversal signal detected!")

// ============================================================================
// DEBUG TABLE
// ============================================================================

// Create debug table
var table debugTable = table.new(position.top_right, 2, 8,
                                 border_width=1,
                                 border_color=color.gray,
                                 frame_width=1,
                                 frame_color=color.gray)

if barstate.islast
    // Header
    table.cell(debugTable, 0, 0, "Metric", bgcolor=color.new(color.blue, 80), text_color=color.white)
    table.cell(debugTable, 1, 0, "Value", bgcolor=color.new(color.blue, 80), text_color=color.white)

    // RSI
    rsiColor = isOversold ? color.new(color.green, 80) : (isOverbought ? color.new(color.red, 80) : color.new(color.gray, 80))
    table.cell(debugTable, 0, 1, "RSI", bgcolor=color.new(color.gray, 90))
    table.cell(debugTable, 1, 1, str.tostring(rsi, "#.##"), bgcolor=rsiColor)

    // RSI State
    rsiState = isOversold ? "Oversold" : (isOverbought ? "Overbought" : "Neutral")
    table.cell(debugTable, 0, 2, "State", bgcolor=color.new(color.gray, 90))
    table.cell(debugTable, 1, 2, rsiState, bgcolor=rsiColor)

    // Volume Momentum
    volumeColor = strongMomentum ? color.new(color.green, 80) : color.new(color.gray, 80)
    table.cell(debugTable, 0, 3, "Vol Momentum", bgcolor=color.new(color.gray, 90))
    table.cell(debugTable, 1, 3, str.tostring(volumeMomentum, "#.##"), bgcolor=volumeColor)

    // Last Bullish Signal
    bullishBarsAgo = not na(lastBullishBar) ? bar_index - lastBullishBar : -1
    bullishText = bullishBarsAgo >= 0 ? str.tostring(bullishBarsAgo) + " bars ago" : "None"
    table.cell(debugTable, 0, 4, "Last Bullish", bgcolor=color.new(color.gray, 90))
    table.cell(debugTable, 1, 4, bullishText, bgcolor=color.new(color.green, 90))

    // Last Bearish Signal
    bearishBarsAgo = not na(lastBearishBar) ? bar_index - lastBearishBar : -1
    bearishText = bearishBarsAgo >= 0 ? str.tostring(bearishBarsAgo) + " bars ago" : "None"
    table.cell(debugTable, 0, 5, "Last Bearish", bgcolor=color.new(color.gray, 90))
    table.cell(debugTable, 1, 5, bearishText, bgcolor=color.new(color.red, 90))

    // Bullish Fib Range
    bullishFibText = bullishFibRange > 0 ? str.tostring(bullishFibRange, "#.####") : "N/A"
    table.cell(debugTable, 0, 6, "Bullish Fib Range", bgcolor=color.new(color.gray, 90))
    table.cell(debugTable, 1, 6, bullishFibText, bgcolor=color.new(color.green, 90))

    // Bearish Fib Range
    bearishFibText = bearishFibRange > 0 ? str.tostring(bearishFibRange, "#.####") : "N/A"
    table.cell(debugTable, 0, 7, "Bearish Fib Range", bgcolor=color.new(color.gray, 90))
    table.cell(debugTable, 1, 7, bearishFibText, bgcolor=color.new(color.red, 90))
