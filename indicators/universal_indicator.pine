// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TRADERAGENT

//@version=6
indicator("Universal Indicator", overlay=false, max_lines_count=500)

// ============================================================================
// INPUTS
// ============================================================================

// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI Settings")
rsiSmoothLength = input.int(3, "RSI Smoothing Length", minval=1, group="RSI Settings")
rsiOversold = input.int(30, "RSI Oversold Level", minval=1, maxval=50, group="RSI Settings")
rsiOverbought = input.int(70, "RSI Overbought Level", minval=50, maxval=100, group="RSI Settings")

// Volume-Momentum Settings
volumeMaLength = input.int(20, "Volume MA Length", minval=1, group="Momentum Settings")
momentumThreshold = input.float(1.2, "Momentum Threshold", minval=1.0, step=0.1, group="Momentum Settings")

// Fibonacci Settings
fibLookback = input.int(100, "Fibonacci Lookback Period", minval=10, group="Fibonacci Settings")
showFibLevels = input.bool(true, "Show Fibonacci Levels on Chart", group="Fibonacci Settings")

// Display Settings
showBullishSignals = input.bool(true, "Show Bullish Signals", group="Display Settings")
showBearishSignals = input.bool(true, "Show Bearish Signals", group="Display Settings")
showZones = input.bool(true, "Show Colored Zones", group="Display Settings")

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

// RSI Calculation
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// Volume Momentum (normalized volume relative to its moving average)
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa

// State Detection
isOversold = rsi < rsiOversold
isOverbought = rsi > rsiOverbought
isNeutral = not isOversold and not isOverbought

// Momentum Confirmation
strongMomentum = volumeMomentum > momentumThreshold

// ============================================================================
// SIGNAL DETECTION LOGIC
// ============================================================================

// Bullish Signal: Transition from oversold with momentum
// - RSI crosses above oversold level
// - Volume momentum is strong
// - RSI smooth is rising
bullishTransition = ta.crossover(rsi, rsiOversold)
rsiRising = rsiSmooth > rsiSmooth[1]
bullishSignal = bullishTransition and strongMomentum and rsiRising

// Bearish Signal: Transition from overbought with momentum
// - RSI crosses below overbought level
// - Volume momentum is strong
// - RSI smooth is falling
bearishTransition = ta.crossunder(rsi, rsiOverbought)
rsiFalling = rsiSmooth < rsiSmooth[1]
bearishSignal = bearishTransition and strongMomentum and rsiFalling

// Track signals for Fibonacci drawing
var int lastBullishBar = na
var int lastBearishBar = na
var float lastBullishLow = na
var float lastBullishHigh = na
var float lastBearishLow = na
var float lastBearishHigh = na

if bullishSignal
    lastBullishBar := bar_index
    // Find swing points in lookback period
    lastBullishLow := ta.lowest(low, fibLookback)
    lastBullishHigh := ta.highest(high, fibLookback)

if bearishSignal
    lastBearishBar := bar_index
    // Find swing points in lookback period
    lastBearishLow := ta.lowest(low, fibLookback)
    lastBearishHigh := ta.highest(high, fibLookback)

// ============================================================================
// FIBONACCI LEVELS CALCULATION
// ============================================================================

// Bullish Fibonacci Levels (from low to high)
bullishFibRange = not na(lastBullishHigh) and not na(lastBullishLow) ? lastBullishHigh - lastBullishLow : 0.0
bullishFib0 = not na(lastBullishLow) ? lastBullishLow : 0.0
bullishFib236 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.236 : 0.0
bullishFib382 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.382 : 0.0
bullishFib50 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.500 : 0.0
bullishFib618 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.618 : 0.0
bullishFib786 = bullishFibRange > 0 ? lastBullishLow + bullishFibRange * 0.786 : 0.0
bullishFib100 = not na(lastBullishHigh) ? lastBullishHigh : 0.0

// Bearish Fibonacci Levels (from high to low)
bearishFibRange = not na(lastBearishHigh) and not na(lastBearishLow) ? lastBearishHigh - lastBearishLow : 0.0
bearishFib0 = not na(lastBearishHigh) ? lastBearishHigh : 0.0
bearishFib236 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.236 : 0.0
bearishFib382 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.382 : 0.0
bearishFib50 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.500 : 0.0
bearishFib618 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.618 : 0.0
bearishFib786 = bearishFibRange > 0 ? lastBearishHigh - bearishFibRange * 0.786 : 0.0
bearishFib100 = not na(lastBearishLow) ? lastBearishLow : 0.0

// ============================================================================
// VISUALIZATION - INDICATOR PANEL
// ============================================================================

// Enhanced color scheme for better readability
rsiColor = isOversold ? color.new(color.lime, 0) :
            isOverbought ? color.new(color.red, 0) :
            rsi > 50 ? color.new(color.aqua, 0) :
            color.new(color.orange, 0)

// Plot RSI with dynamic coloring
plot(rsi, "RSI", color=rsiColor, linewidth=3, style=plot.style_line)
plot(rsiSmooth, "RSI Smooth", color=color.new(color.yellow, 0), linewidth=2, style=plot.style_line)

// Plot levels with enhanced visibility
hline(rsiOversold, "Oversold", color=color.new(color.green, 0), linestyle=hline.style_solid, linewidth=2)
hline(50, "Midline", color=color.new(color.white, 60), linestyle=hline.style_dotted, linewidth=1)
hline(rsiOverbought, "Overbought", color=color.new(color.red, 0), linestyle=hline.style_solid, linewidth=2)

// Enhanced colored zones with gradient effect
oversoldZoneColor = showZones and isOversold ? color.new(color.green, 85) : na
overboughtZoneColor = showZones and isOverbought ? color.new(color.red, 85) : na
neutralBullishZone = showZones and isNeutral and rsi > 50 ? color.new(color.blue, 95) : na
neutralBearishZone = showZones and isNeutral and rsi < 50 ? color.new(color.orange, 95) : na

bgcolor(oversoldZoneColor, title="Oversold Zone")
bgcolor(overboughtZoneColor, title="Overbought Zone")
bgcolor(neutralBullishZone, title="Neutral Bullish Zone")
bgcolor(neutralBearishZone, title="Neutral Bearish Zone")

// Plot Volume Momentum as enhanced histogram
volumeMomentumScaled = (volumeMomentum - 1) * 50 + 50  // Scale to RSI range
volumeHistColor = volumeMomentum > momentumThreshold * 1.5 ? color.new(color.lime, 30) :
                  volumeMomentum > momentumThreshold ? color.new(color.green, 50) :
                  volumeMomentum > 1.0 ? color.new(color.gray, 70) :
                  color.new(color.red, 70)

plot(volumeMomentumScaled, "Volume Momentum", style=plot.style_histogram, color=volumeHistColor, linewidth=2)

// Enhanced signal markers on indicator panel
plotshape(showBullishSignals and bullishSignal, "Bullish Signal Marker",
         location=location.bottom, color=color.new(color.lime, 0),
         style=shape.triangleup, size=size.normal, text="LONG")

plotshape(showBearishSignals and bearishSignal, "Bearish Signal Marker",
         location=location.top, color=color.new(color.red, 0),
         style=shape.triangledown, size=size.normal, text="SHORT")

// Add background flash on signal
signalBgColor = showBullishSignals and bullishSignal ? color.new(color.green, 70) :
                showBearishSignals and bearishSignal ? color.new(color.red, 70) :
                na
bgcolor(signalBgColor, title="Signal Flash", editable=false)

// ============================================================================
// VISUALIZATION - FIBONACCI LEVELS ON CHART (OVERLAY)
// ============================================================================

// Note: Since this indicator has overlay=false, we'll use plotchar to mark
// the price chart indirectly. For full Fibonacci visualization, users should
// add the companion overlay indicator or use the alert system.

// ============================================================================
// ALERTS
// ============================================================================

// Alert conditions
alertcondition(bullishSignal, "Bullish Signal", "Universal Indicator: Bullish reversal signal detected!")
alertcondition(bearishSignal, "Bearish Signal", "Universal Indicator: Bearish reversal signal detected!")

// ============================================================================
// ENHANCED DEBUG TABLE
// ============================================================================

// Create enhanced debug table with modern styling
var table debugTable = table.new(position.bottom_right, 2, 10,
                                 border_width=2,
                                 border_color=color.new(color.blue, 50),
                                 frame_width=2,
                                 frame_color=color.new(color.blue, 30))

if barstate.islast
    // Header with gradient
    table.cell(debugTable, 0, 0, "ðŸ“Š Indicator Metrics",
               bgcolor=color.new(color.blue, 60),
               text_color=color.white,
               text_size=size.normal)
    table.cell(debugTable, 1, 0, "Current Status",
               bgcolor=color.new(color.blue, 60),
               text_color=color.white,
               text_size=size.normal)

    // RSI with enhanced colors
    rsiCellColor = isOversold ? color.new(color.lime, 75) :
                   isOverbought ? color.new(color.red, 75) :
                   rsi > 50 ? color.new(color.aqua, 85) :
                   color.new(color.orange, 85)
    table.cell(debugTable, 0, 1, "RSI Level",
               bgcolor=color.new(color.gray, 90),
               text_color=color.white,
               text_size=size.small)
    table.cell(debugTable, 1, 1, str.tostring(rsi, "#.##"),
               bgcolor=rsiCellColor,
               text_color=color.white,
               text_size=size.large)

    // RSI State with icons
    rsiState = isOversold ? "ðŸŸ¢ Oversold" : (isOverbought ? "ðŸ”´ Overbought" : "âšª Neutral")
    table.cell(debugTable, 0, 2, "Market State",
               bgcolor=color.new(color.gray, 90),
               text_color=color.white,
               text_size=size.small)
    table.cell(debugTable, 1, 2, rsiState,
               bgcolor=rsiCellColor,
               text_color=color.white,
               text_size=size.normal)

    // Volume Momentum with gradient
    volumeColor = strongMomentum and volumeMomentum > momentumThreshold * 1.5 ? color.new(color.lime, 75) :
                  strongMomentum ? color.new(color.green, 80) :
                  color.new(color.gray, 85)
    table.cell(debugTable, 0, 3, "Volume Power",
               bgcolor=color.new(color.gray, 90),
               text_color=color.white,
               text_size=size.small)
    volumeText = str.tostring(volumeMomentum, "#.##") + "x"
    table.cell(debugTable, 1, 3, volumeText,
               bgcolor=volumeColor,
               text_color=color.white,
               text_size=size.normal)

    // Candle pattern detection
    currentCandleType = close > open ? "ðŸŸ¢ Bullish" :
                       close < open ? "ðŸ”´ Bearish" :
                       "âšª Doji"
    table.cell(debugTable, 0, 4, "Candle Type",
               bgcolor=color.new(color.gray, 90),
               text_color=color.white,
               text_size=size.small)
    candleColor = close > open ? color.new(color.green, 85) :
                  close < open ? color.new(color.red, 85) :
                  color.new(color.gray, 85)
    table.cell(debugTable, 1, 4, currentCandleType,
               bgcolor=candleColor,
               text_color=color.white,
               text_size=size.small)

    // Separator
    table.cell(debugTable, 0, 5, "â”â”â”â”â”â”â”â”â”â”",
               bgcolor=color.new(color.gray, 95),
               text_color=color.gray,
               text_size=size.tiny)
    table.cell(debugTable, 1, 5, "â”â”â”â”â”â”â”â”â”â”",
               bgcolor=color.new(color.gray, 95),
               text_color=color.gray,
               text_size=size.tiny)

    // Last Bullish Signal
    bullishBarsAgo = not na(lastBullishBar) ? bar_index - lastBullishBar : -1
    bullishText = bullishBarsAgo >= 0 ? "ðŸŸ¢ " + str.tostring(bullishBarsAgo) + " bars" : "â³ None"
    table.cell(debugTable, 0, 6, "Last LONG",
               bgcolor=color.new(color.gray, 90),
               text_color=color.white,
               text_size=size.small)
    table.cell(debugTable, 1, 6, bullishText,
               bgcolor=color.new(color.green, 85),
               text_color=color.white,
               text_size=size.small)

    // Last Bearish Signal
    bearishBarsAgo = not na(lastBearishBar) ? bar_index - lastBearishBar : -1
    bearishText = bearishBarsAgo >= 0 ? "ðŸ”´ " + str.tostring(bearishBarsAgo) + " bars" : "â³ None"
    table.cell(debugTable, 0, 7, "Last SHORT",
               bgcolor=color.new(color.gray, 90),
               text_color=color.white,
               text_size=size.small)
    table.cell(debugTable, 1, 7, bearishText,
               bgcolor=color.new(color.red, 85),
               text_color=color.white,
               text_size=size.small)

    // Bullish Fib Range
    bullishFibText = bullishFibRange > 0 ? str.tostring(bullishFibRange, "#.####") : "N/A"
    table.cell(debugTable, 0, 8, "LONG Range",
               bgcolor=color.new(color.gray, 90),
               text_color=color.white,
               text_size=size.tiny)
    table.cell(debugTable, 1, 8, bullishFibText,
               bgcolor=color.new(color.green, 90),
               text_color=color.white,
               text_size=size.tiny)

    // Bearish Fib Range
    bearishFibText = bearishFibRange > 0 ? str.tostring(bearishFibRange, "#.####") : "N/A"
    table.cell(debugTable, 0, 9, "SHORT Range",
               bgcolor=color.new(color.gray, 90),
               text_color=color.white,
               text_size=size.tiny)
    table.cell(debugTable, 1, 9, bearishFibText,
               bgcolor=color.new(color.red, 90),
               text_color=color.white,
               text_size=size.tiny)
