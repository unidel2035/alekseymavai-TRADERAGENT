// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© TRADERAGENT

//@version=6
indicator("BGAKKCLOD v2 - Advanced Candle Detector", shorttitle="BGAKKCLOD v2", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================================================
// –û–ü–ò–°–ê–ù–ò–ï / DESCRIPTION
// ============================================================================
// BGAKKCLOD v2 - —É—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
// –∫–ª—é—á–µ–≤—ã—Ö —Å–≤–µ—á–µ–π –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö.
//
// BGAKKCLOD v2 - advanced indicator for automatic detection of key candles
// and drawing Fibonacci levels in absolute values.
//
// –û—Å–Ω–æ–≤–∞–Ω –Ω–∞: Universal Indicator v2, UI v3 Fib
// Based on: Universal Indicator v2, UI v3 Fib
//
// –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å: –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Å–≤–µ—á—É, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á–∏
// Main goal: identify the candle on which Fibonacci levels should be applied

// ============================================================================
// –í–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ / INPUTS
// ============================================================================

// RSI Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI
rsiLength = input.int(14, "RSI Length / –ü–µ—Ä–∏–æ–¥ RSI", minval=1, group="üéØ Signal Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤")
rsiSmoothLength = input.int(3, "RSI Smoothing / –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ RSI", minval=1, group="üéØ Signal Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤")
rsiOversold = input.int(30, "Oversold Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏", minval=1, maxval=50, group="üéØ Signal Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤")
rsiOverbought = input.int(70, "Overbought Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏", minval=50, maxval=100, group="üéØ Signal Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤")

// Volume-Momentum Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–º–∞ –∏ –º–æ–º–µ–Ω—Ç—É–º–∞
volumeMaLength = input.int(20, "Volume MA Length / –ü–µ—Ä–∏–æ–¥ MA –æ–±—ä–µ–º–∞", minval=1, group="üéØ Signal Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤")
momentumThreshold = input.float(1.2, "Momentum Threshold / –ü–æ—Ä–æ–≥ –º–æ–º–µ–Ω—Ç—É–º–∞", minval=1.0, step=0.1, group="üéØ Signal Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤")
minBarsBetweenSignals = input.int(10, "Min Bars Between Signals / –ú–∏–Ω. –±–∞—Ä–æ–≤ –º–µ–∂–¥—É —Å–∏–≥–Ω–∞–ª–∞–º–∏", minval=1, group="üéØ Signal Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤")

// Fibonacci Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§–∏–±–æ–Ω–∞—á—á–∏
showBullishFib = input.bool(true, "Show Bullish Fibonacci / –ü–æ–∫–∞–∑–∞—Ç—å –±—ã—á—å–∏ —É—Ä–æ–≤–Ω–∏", group="üìä Fibonacci Levels / –£—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏")
showBearishFib = input.bool(true, "Show Bearish Fibonacci / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–¥–≤–µ–∂—å–∏ —É—Ä–æ–≤–Ω–∏", group="üìä Fibonacci Levels / –£—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏")
lineExtension = input.int(10, "Line Extension (bars) / –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π (—Å–≤–µ—á–µ–π)", minval=1, maxval=50, group="üìä Fibonacci Levels / –£—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏")
showTable = input.bool(true, "Show Levels Table / –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —É—Ä–æ–≤–Ω–µ–π", group="üìä Fibonacci Levels / –£—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏")

// Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
highlightBullishCandles = input.bool(true, "Highlight Bullish Candles / –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –±—ã—á—å–∏ —Å–≤–µ—á–∏", group="üé® Visual Style / –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å")
highlightBearishCandles = input.bool(true, "Highlight Bearish Candles / –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –º–µ–¥–≤–µ–∂—å–∏ —Å–≤–µ—á–∏", group="üé® Visual Style / –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å")
bullishCandleColor = input.color(color.new(#00FF00, 0), "Bullish Candle Color / –¶–≤–µ—Ç –±—ã—á—å–∏—Ö —Å–≤–µ—á–µ–π", group="üé® Visual Style / –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å")
bearishCandleColor = input.color(color.new(#FF0000, 0), "Bearish Candle Color / –¶–≤–µ—Ç –º–µ–¥–≤–µ–∂—å–∏—Ö —Å–≤–µ—á–µ–π", group="üé® Visual Style / –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å")

// Breakeven Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑—É–±—ã—Ç–∫–∞
enableBreakeven = input.bool(true, "Enable Breakeven SL / –í–∫–ª—é—á–∏—Ç—å –±–µ–∑—É–±—ã—Ç–æ—á–Ω—ã–π –°–õ", group="‚ö° Risk Management / –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏")
breakevenOffset = input.float(0.0, "Breakeven Offset % / –û—Ç—Å—Ç—É–ø –±–µ–∑—É–±—ã—Ç–∫–∞ %", minval=0.0, step=0.1, group="‚ö° Risk Management / –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏")

// ============================================================================
// –í–´–ß–ò–°–õ–ï–ù–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–û–í / INDICATOR CALCULATIONS
// ============================================================================

// RSI Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ RSI
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// Volume Momentum / –û–±—ä–µ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç—É–º
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa

// State Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
isOversold = rsi < rsiOversold
isOverbought = rsi > rsiOverbought

// Momentum Confirmation / –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–æ–º–µ–Ω—Ç—É–º–∞
strongMomentum = volumeMomentum > momentumThreshold

// ============================================================================
// –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –°–ò–ì–ù–ê–õ–û–í / SIGNAL DETECTION LOGIC
// ============================================================================

// Bullish Signal / –ë—ã—á–∏–π —Å–∏–≥–Ω–∞–ª:
// - RSI –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö —É—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏
// - –°–≥–ª–∞–∂–µ–Ω–Ω—ã–π RSI —Ä–∞—Å—Ç–µ—Ç (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞)
// - –û–±—ä–µ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç—É–º —Å–∏–ª—å–Ω—ã–π (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π)
bullishTransition = ta.crossover(rsi, rsiOversold)
rsiRising = rsiSmooth > rsiSmooth[1]
bullishSignalRaw = bullishTransition and strongMomentum and rsiRising

// Bearish Signal / –ú–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª:
// - RSI –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ —É—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏
// - –°–≥–ª–∞–∂–µ–Ω–Ω—ã–π RSI –ø–∞–¥–∞–µ—Ç (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞)
// - –û–±—ä–µ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç—É–º —Å–∏–ª—å–Ω—ã–π (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü–æ–≤)
bearishTransition = ta.crossunder(rsi, rsiOverbought)
rsiFalling = rsiSmooth < rsiSmooth[1]
bearishSignalRaw = bearishTransition and strongMomentum and rsiFalling

// Filter signals to avoid too frequent triggers
// –§–∏–ª—å—Ç—Ä —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
var int lastSignalBar = na
signalAllowed = na(lastSignalBar) or (bar_index - lastSignalBar) >= minBarsBetweenSignals

bullishSignal = bullishSignalRaw and signalAllowed
bearishSignal = bearishSignalRaw and signalAllowed

// Update last signal bar / –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–∞—Ä–∞ —Å —Å–∏–≥–Ω–∞–ª–æ–º
if bullishSignal or bearishSignal
    lastSignalBar := bar_index

// ============================================================================
// –ü–û–î–°–í–ï–¢–ö–ê –°–í–ï–ß–ï–ô / CANDLE HIGHLIGHTING
// ============================================================================

// Highlight signal candles with custom colors
// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª—å–Ω—ã—Ö —Å–≤–µ—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Ü–≤–µ—Ç–∞–º–∏
candleColor = na
if highlightBullishCandles and bullishSignal
    candleColor := bullishCandleColor
else if highlightBearishCandles and bearishSignal
    candleColor := bearishCandleColor

barcolor(candleColor, title="Signal Candle Color / –¶–≤–µ—Ç —Å–∏–≥–Ω–∞–ª—å–Ω–æ–π —Å–≤–µ—á–∏")

// ============================================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –§–ò–ë–û–ù–ê–ß–ß–ò / FIBONACCI MANAGEMENT
// ============================================================================

// Arrays to store Fibonacci drawing objects
// –ú–∞—Å—Å–∏–≤—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –§–∏–±–æ–Ω–∞—á—á–∏
var line[] activeFibLines = array.new<line>()
var label[] activeFibLabels = array.new<label>()

// Store signal information
// –•—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–≥–Ω–∞–ª–µ
var bool lastSignalIsBullish = false
var float signalCandleLow = na
var float signalCandleHigh = na
var int signalBarIndex = na
var float entryPrice = na
var bool tp1Reached = false

// Function to delete old Fibonacci objects
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –§–∏–±–æ–Ω–∞—á—á–∏
deleteOldFibonacci() =>
    // Delete lines / –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π
    if array.size(activeFibLines) > 0
        for i = array.size(activeFibLines) - 1 to 0
            line.delete(array.get(activeFibLines, i))
        array.clear(activeFibLines)

    // Delete labels / –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫
    if array.size(activeFibLabels) > 0
        for i = array.size(activeFibLabels) - 1 to 0
            label.delete(array.get(activeFibLabels, i))
        array.clear(activeFibLabels)

// Function to calculate logarithmic Fibonacci price
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω—ã –§–∏–±–æ–Ω–∞—á—á–∏
calcLogFibPrice(float lowPrice, float highPrice, float level) =>
    float result = na
    if not na(lowPrice) and not na(highPrice) and lowPrice > 0 and highPrice > 0
        logLow = math.log(lowPrice)
        logHigh = math.log(highPrice)
        logRange = logHigh - logLow
        logPrice = logHigh - (logRange * level)
        result := math.exp(logPrice)
    result

// Function to draw Fibonacci levels with absolute values
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
drawFibonacci(float candleLow, float candleHigh, int sigBar, bool isBullish) =>
    if not na(candleLow) and not na(candleHigh) and candleLow > 0 and candleHigh > 0 and candleHigh > candleLow

        // Define Fibonacci levels
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
        levels = array.from(-2.618, -1.618, -0.618, 0.0, 0.382, 0.5, 0.618, 0.786, 1.0)
        levelNames = array.from(
             "TP3",
             "TP2",
             "TP1",
             "Entry #1",
             "Entry #2",
             "Entry #3",
             "Entry #4",
             "STOP LOSS",
             "Base"
         )

        // Color scheme for levels / –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
        levelColors = array.from(
             color.new(#00FF00, 0),     // TP3 - bright green
             color.new(#00CC00, 0),     // TP2 - green
             color.new(#009900, 0),     // TP1 - dark green
             color.new(#FF6600, 0),     // Entry #1 - orange
             color.new(#FFFF00, 20),    // Entry #2 - yellow
             color.new(#FFD700, 20),    // Entry #3 - gold
             color.new(#FFA500, 20),    // Entry #4 - light orange
             color.new(#FF0000, 0),     // STOP LOSS - red
             color.new(#0066FF, 20)     // Base - blue
         )

        // Line widths / –¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–π
        levelWidths = array.from(2, 2, 2, 3, 2, 2, 2, 3, 2)

        // Draw each level / –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è
        for i = 0 to array.size(levels) - 1
            levelRatio = array.get(levels, i)
            levelPrice = calcLogFibPrice(candleLow, candleHigh, levelRatio)

            if not na(levelPrice) and levelPrice > 0
                levelName = array.get(levelNames, i)
                lineColor = array.get(levelColors, i)
                lineWidth = array.get(levelWidths, i)

                // Create horizontal line extending to the right
                // –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ —Å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –≤–ø—Ä–∞–≤–æ
                newLine = line.new(
                     x1=sigBar,
                     y1=levelPrice,
                     x2=sigBar + lineExtension,
                     y2=levelPrice,
                     color=lineColor,
                     width=lineWidth,
                     style=line.style_solid
                 )

                array.push(activeFibLines, newLine)

// ============================================================================
// –û–ë–†–ê–ë–û–¢–ö–ê –°–ò–ì–ù–ê–õ–û–í / SIGNAL HANDLING
// ============================================================================

// Handle bullish signals / –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã—á—å–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
if bullishSignal and showBullishFib
    // Delete old Fibonacci levels / –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
    deleteOldFibonacci()

    // Store signal information / –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–≥–Ω–∞–ª–µ
    signalCandleLow := low[0]
    signalCandleHigh := high[0]
    signalBarIndex := bar_index
    lastSignalIsBullish := true
    entryPrice := high[0]  // Entry at High of the candle
    tp1Reached := false

    // Draw Fibonacci levels / –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
    drawFibonacci(signalCandleLow, signalCandleHigh, bar_index, true)

// Handle bearish signals / –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–≤–µ–∂—å–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
if bearishSignal and showBearishFib
    // Delete old Fibonacci levels / –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
    deleteOldFibonacci()

    // Store signal information / –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏–≥–Ω–∞–ª–µ
    signalCandleLow := low[0]
    signalCandleHigh := high[0]
    signalBarIndex := bar_index
    lastSignalIsBullish := false
    entryPrice := low[0]  // Entry at Low of the candle
    tp1Reached := false

    // Draw Fibonacci levels / –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
    drawFibonacci(signalCandleLow, signalCandleHigh, bar_index, false)

// ============================================================================
// –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –î–û–°–¢–ò–ñ–ï–ù–ò–Ø TP1 / TP1 TRACKING
// ============================================================================

// Check if TP1 has been reached
// –ü—Ä–æ–≤–µ—Ä–∫–∞, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏ TP1
if not na(signalCandleLow) and not na(signalCandleHigh) and not tp1Reached
    tp1Price = calcLogFibPrice(signalCandleLow, signalCandleHigh, -0.618)

    if lastSignalIsBullish and not na(tp1Price)
        // For bullish: check if high reached TP1
        if high >= tp1Price
            tp1Reached := true
    else if not lastSignalIsBullish and not na(tp1Price)
        // For bearish: check if low reached TP1
        if low <= tp1Price
            tp1Reached := true

// ============================================================================
// –¢–ê–ë–õ–ò–¶–ê –£–†–û–í–ù–ï–ô / LEVELS TABLE
// ============================================================================

// Create table to display Fibonacci levels in absolute values
// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
var table fibTable = table.new(position.top_right, 3, 10, border_width=1)

if showTable and barstate.islast and not na(signalCandleLow) and not na(signalCandleHigh)
    // Clear table first / –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
    table.clear(fibTable, 0, 0, 2, 9)

    // Table header / –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
    signalType = lastSignalIsBullish ? "LONG üü¢" : "SHORT üî¥"
    table.cell(fibTable, 0, 0, "–£—Ä–æ–≤–µ–Ω—å / Level", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.small)
    table.cell(fibTable, 1, 0, "–¶–µ–Ω–∞ / Price", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.small)
    table.cell(fibTable, 2, 0, signalType, text_color=color.white, bgcolor=lastSignalIsBullish ? color.new(color.green, 30) : color.new(color.red, 30), text_size=size.small)

    // Define levels for table / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
    levels = array.from(-2.618, -1.618, -0.618, 0.0, 0.382, 0.5, 0.618, 0.786, 1.0)
    levelNames = array.from("TP3", "TP2", "TP1", "Entry #1", "Entry #2", "Entry #3", "Entry #4", "STOP LOSS", "Base")
    levelAnnotations = array.from(
         "–ó–∞–∫—Ä—ã—Ç—å 40%",
         "–ó–∞–∫—Ä—ã—Ç—å 30%",
         "–ó–∞–∫—Ä—ã—Ç—å 30%",
         "–†—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä",
         "–õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä",
         "–õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä",
         "–õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä",
         tp1Reached and enableBreakeven ? "–ë–ï–ó–£–ë–´–¢–û–ö" : "–°—Ç–æ–ø-–ª–æ—Å—Å",
         "–û—Å–Ω–æ–≤–∞–Ω–∏–µ"
     )

    // Colors matching the lines / –¶–≤–µ—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ª–∏–Ω–∏—è–º
    levelColors = array.from(
         color.new(#00FF00, 60),    // TP3
         color.new(#00CC00, 60),    // TP2
         color.new(#009900, 60),    // TP1
         color.new(#FF6600, 60),    // Entry #1
         color.new(#FFFF00, 60),    // Entry #2
         color.new(#FFD700, 60),    // Entry #3
         color.new(#FFA500, 60),    // Entry #4
         color.new(#FF0000, 60),    // STOP LOSS
         color.new(#0066FF, 60)     // Base
     )

    // Fill table rows / –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
    for i = 0 to array.size(levels) - 1
        levelRatio = array.get(levels, i)
        levelPrice = calcLogFibPrice(signalCandleLow, signalCandleHigh, levelRatio)

        // Special handling for STOP LOSS when TP1 is reached
        // –û—Å–æ–±–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è STOP LOSS –∫–æ–≥–¥–∞ TP1 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
        if i == 7 and tp1Reached and enableBreakeven and not na(entryPrice)
            // Move SL to breakeven / –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –°–õ –≤ –±–µ–∑—É–±—ã—Ç–æ–∫
            offsetAmount = entryPrice * breakevenOffset / 100
            if lastSignalIsBullish
                levelPrice := entryPrice + offsetAmount
            else
                levelPrice := entryPrice - offsetAmount

        if not na(levelPrice) and levelPrice > 0
            levelName = array.get(levelNames, i)
            annotation = array.get(levelAnnotations, i)
            bgColor = array.get(levelColors, i)

            table.cell(fibTable, 0, i + 1, levelName, text_color=color.white, bgcolor=bgColor, text_size=size.small)
            table.cell(fibTable, 1, i + 1, str.tostring(levelPrice, format.mintick), text_color=color.white, bgcolor=bgColor, text_size=size.small)
            table.cell(fibTable, 2, i + 1, annotation, text_color=color.white, bgcolor=bgColor, text_size=size.small)

// ============================================================================
// –ú–ê–†–ö–ï–†–´ –°–í–ï–ß–ï–ô / CANDLE MARKERS
// ============================================================================

// Mark bullish signal candles / –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –±—ã—á—å–∏—Ö —Å–∏–≥–Ω–∞–ª—å–Ω—ã—Ö —Å–≤–µ—á–µ–π
plotshape(
     bullishSignal,
     title="Bullish Signal / –ë—ã—á–∏–π —Å–∏–≥–Ω–∞–ª",
     location=location.belowbar,
     color=color.new(color.green, 0),
     style=shape.triangleup,
     size=size.small,
     text="üü¢"
 )

// Mark bearish signal candles / –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –º–µ–¥–≤–µ–∂—å–∏—Ö —Å–∏–≥–Ω–∞–ª—å–Ω—ã—Ö —Å–≤–µ—á–µ–π
plotshape(
     bearishSignal,
     title="Bearish Signal / –ú–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª",
     location=location.abovebar,
     color=color.new(color.red, 0),
     style=shape.triangledown,
     size=size.small,
     text="üî¥"
 )

// ============================================================================
// –ê–õ–ï–†–¢–´ / ALERTS
// ============================================================================

alertcondition(bullishSignal, "Bullish Signal / –ë—ã—á–∏–π —Å–∏–≥–Ω–∞–ª",
               "BGAKKCLOD v2: Bullish reversal signal detected! / –û–±–Ω–∞—Ä—É–∂–µ–Ω –±—ã—á–∏–π —Å–∏–≥–Ω–∞–ª —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞!")

alertcondition(bearishSignal, "Bearish Signal / –ú–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª",
               "BGAKKCLOD v2: Bearish reversal signal detected! / –û–±–Ω–∞—Ä—É–∂–µ–Ω –º–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞!")

alertcondition(tp1Reached, "TP1 Reached / TP1 –î–æ—Å—Ç–∏–≥–Ω—É—Ç",
               "BGAKKCLOD v2: TP1 reached, consider moving SL to breakeven! / TP1 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–µ—Ä–µ–Ω–æ—Å –°–õ –≤ –±–µ–∑—É–±—ã—Ç–æ–∫!")

// ============================================================================
// –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò / NOTES
// ============================================================================

// –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–≤–µ—á–µ–π:
// Key candle detection algorithm:
//
// 1. –ë—ã—á–∏–π —Å–∏–≥–Ω–∞–ª (–∑–µ–ª–µ–Ω–∞—è —Å–≤–µ—á–∞) / Bullish signal (green candle):
//    - RSI –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –∑–æ–Ω—ã –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏ (<30), –ø–µ—Ä–µ—Å–µ–∫–∞—è —É—Ä–æ–≤–µ–Ω—å –≤–≤–µ—Ä—Ö
//    - –°–≥–ª–∞–∂–µ–Ω–Ω—ã–π RSI –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤–≤–µ—Ä—Ö (—Ä–∞—Å—Ç—É—â–∏–π –º–æ–º–µ–Ω—Ç—É–º)
//    - –û–±—ä–µ–º –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤ 1.2 —Ä–∞–∑–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–∞)
//    - –ü—Ä–æ—à–ª–æ –º–∏–Ω–∏–º—É–º 10 –±–∞—Ä–æ–≤ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
//
// 2. –ú–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª (–∫—Ä–∞—Å–Ω–∞—è —Å–≤–µ—á–∞) / Bearish signal (red candle):
//    - RSI –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –∑–æ–Ω—ã –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏ (>70), –ø–µ—Ä–µ—Å–µ–∫–∞—è —É—Ä–æ–≤–µ–Ω—å –≤–Ω–∏–∑
//    - –°–≥–ª–∞–∂–µ–Ω–Ω—ã–π RSI –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤–Ω–∏–∑ (–ø–∞–¥–∞—é—â–∏–π –º–æ–º–µ–Ω—Ç—É–º)
//    - –û–±—ä–µ–º –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤ 1.2 —Ä–∞–∑–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è)
//    - –ü—Ä–æ—à–ª–æ –º–∏–Ω–∏–º—É–º 10 –±–∞—Ä–æ–≤ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
//
// 3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ / Fibonacci level construction:
//    - –û—Ç Low –¥–æ High —Å–∏–≥–Ω–∞–ª—å–Ω–æ–π —Å–≤–µ—á–∏
//    - –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –Ω–∞ –≤—Å–µ—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞—Ö
//    - 9 —É—Ä–æ–≤–Ω–µ–π: TP3, TP2, TP1, Entry #1-4, STOP LOSS, Base
//    - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö —Ü–µ–Ω–∞—Ö (–Ω–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)
//    - –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π –Ω–∞ 10 —Å–≤–µ—á–µ–π –≤–ø—Ä–∞–≤–æ
//
// 4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏ / Risk management:
//    - Entry #1 (0%) = High/Low —Å–∏–≥–Ω–∞–ª—å–Ω–æ–π —Å–≤–µ—á–∏ (—Ä—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä)
//    - Entry #2-4 (38.2%, 50%, 61.8%) = –ª–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
//    - TP1, TP2, TP3 = —Ü–µ–ª–∏ —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø—Ä–∏–±—ã–ª–∏ (30%, 30%, 40%)
//    - STOP LOSS (78.6%) = –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–æ–ø-–ª–æ—Å—Å
//    - –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è TP1: —Å—Ç–æ–ø-–ª–æ—Å—Å –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –≤ –±–µ–∑—É–±—ã—Ç–æ–∫
//
// 5. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ / Visualization features:
//    - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Å–∏–≥–Ω–∞–ª—å–Ω—ã—Ö —Å–≤–µ—á–µ–π
//    - –¢–∞–±–ª–∏—Ü–∞ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
//    - –¶–≤–µ—Ç–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π (–∑–µ–ª–µ–Ω—ã–π = –ø—Ä–æ—Ñ–∏—Ç, –∫—Ä–∞—Å–Ω—ã–π = —Å—Ç–æ–ø)
//    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP1
