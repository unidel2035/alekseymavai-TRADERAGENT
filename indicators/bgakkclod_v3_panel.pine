// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© TRADERAGENT

//@version=6
indicator("BGAKKCLOD v3 Panel", shorttitle="BGAKv3 P", overlay=false, max_lines_count=500, max_labels_count=500)

// ============================================================================
// –û–ü–ò–°–ê–ù–ò–ï / DESCRIPTION
// ============================================================================
// BGAKKCLOD v3 Panel - –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (companion)
// –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤, –Ω–µ –±–æ–ª–µ–µ 10% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
//
// BGAKKCLOD v3 Panel - bottom indicator panel (companion)
// Displays indicator states, max 10% of screen height

// ============================================================================
// –í–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ / INPUTS
// ============================================================================

// RSI Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI
rsiLength = input.int(14, "RSI Length / –ü–µ—Ä–∏–æ–¥ RSI", minval=1, group="üéØ Signal Detection")
rsiSmoothLength = input.int(3, "RSI Smoothing / –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ RSI", minval=1, group="üéØ Signal Detection")
rsiOversold = input.int(30, "Oversold Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏", minval=1, maxval=50, group="üéØ Signal Detection")
rsiOverbought = input.int(70, "Overbought Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏", minval=50, maxval=100, group="üéØ Signal Detection")

// Volume-Momentum Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–º–∞ –∏ –º–æ–º–µ–Ω—Ç—É–º–∞
volumeMaLength = input.int(20, "Volume MA Length / –ü–µ—Ä–∏–æ–¥ MA –æ–±—ä–µ–º–∞", minval=1, group="üéØ Signal Detection")
momentumThreshold = input.float(1.2, "Momentum Threshold / –ü–æ—Ä–æ–≥ –º–æ–º–µ–Ω—Ç—É–º–∞", minval=1.0, step=0.1, group="üéØ Signal Detection")
minBarsBetweenSignals = input.int(10, "Min Bars Between Signals / –ú–∏–Ω. –±–∞—Ä–æ–≤ –º–µ–∂–¥—É —Å–∏–≥–Ω–∞–ª–∞–º–∏", minval=1, group="üéØ Signal Detection")

// Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
showBullishSignals = input.bool(true, "Show Bullish Signals / –ü–æ–∫–∞–∑–∞—Ç—å –±—ã—á—å–∏ —Å–∏–≥–Ω–∞–ª—ã", group="Display Settings")
showBearishSignals = input.bool(true, "Show Bearish Signals / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–¥–≤–µ–∂—å–∏ —Å–∏–≥–Ω–∞–ª—ã", group="Display Settings")
showZones = input.bool(true, "Show Colored Zones / –ü–æ–∫–∞–∑–∞—Ç—å —Ü–≤–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã", group="Display Settings")

// ============================================================================
// –í–´–ß–ò–°–õ–ï–ù–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–û–í / INDICATOR CALCULATIONS
// ============================================================================

// RSI Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ RSI
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// Volume Momentum / –û–±—ä–µ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç—É–º
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa

// State Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
isOversold = rsi < rsiOversold
isOverbought = rsi > rsiOverbought
isNeutral = not isOversold and not isOverbought

// Momentum Confirmation / –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–æ–º–µ–Ω—Ç—É–º–∞
strongMomentum = volumeMomentum > momentumThreshold

// ============================================================================
// –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –°–ò–ì–ù–ê–õ–û–í / SIGNAL DETECTION LOGIC
// ============================================================================

// Bullish Signal / –ë—ã—á–∏–π —Å–∏–≥–Ω–∞–ª
bullishTransition = ta.crossover(rsi, rsiOversold)
rsiRising = rsiSmooth > rsiSmooth[1]
bullishSignalRaw = bullishTransition and strongMomentum and rsiRising

// Bearish Signal / –ú–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª
bearishTransition = ta.crossunder(rsi, rsiOverbought)
rsiFalling = rsiSmooth < rsiSmooth[1]
bearishSignalRaw = bearishTransition and strongMomentum and rsiFalling

// Filter signals
var int lastSignalBar = na
signalAllowed = na(lastSignalBar) or (bar_index - lastSignalBar) >= minBarsBetweenSignals

bullishSignal = bullishSignalRaw and signalAllowed and showBullishSignals
bearishSignal = bearishSignalRaw and signalAllowed and showBearishSignals

// Update last signal bar
if bullishSignal or bearishSignal
    lastSignalBar := bar_index

// Track signals
var int lastBullishBar = na
var int lastBearishBar = na

if bullishSignal
    lastBullishBar := bar_index

if bearishSignal
    lastBearishBar := bar_index

// ============================================================================
// –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø - –ü–ê–ù–ï–õ–¨ –ò–ù–î–ò–ö–ê–¢–û–†–ê / VISUALIZATION - INDICATOR PANEL
// ============================================================================

// Plot RSI / –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ RSI
plot(rsi, "RSI", color=color.new(color.blue, 0), linewidth=2)
plot(rsiSmooth, "RSI Smooth", color=color.new(color.orange, 0), linewidth=1)

// Plot levels / –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π
hline(rsiOversold, "Oversold", color=color.green, linestyle=hline.style_dashed)
hline(50, "Midline", color=color.gray, linestyle=hline.style_dotted)
hline(rsiOverbought, "Overbought", color=color.red, linestyle=hline.style_dashed)

// Colored zones / –¶–≤–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã
oversoldZoneColor = showZones and isOversold ? color.new(color.green, 85) : na
overboughtZoneColor = showZones and isOverbought ? color.new(color.red, 85) : na

bgcolor(oversoldZoneColor, title="Oversold Zone")
bgcolor(overboughtZoneColor, title="Overbought Zone")

// Plot Volume Momentum as histogram
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—ä–µ–º–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç—É–º–∞ –≤ –≤–∏–¥–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
// –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É RSI –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
volumeMomentumScaled = (volumeMomentum - 1) * 50 + 50
volumeColor = volumeMomentum > momentumThreshold ? color.new(color.green, 50) : color.new(color.gray, 70)
plot(volumeMomentumScaled, "Volume Momentum",
     style=plot.style_histogram, color=volumeColor)

// Signal markers on indicator panel
plotshape(bullishSignal, "Bullish Signal",
         location=location.bottom, color=color.new(color.green, 0),
         style=shape.triangleup, size=size.small)

plotshape(bearishSignal, "Bearish Signal",
         location=location.top, color=color.new(color.red, 0),
         style=shape.triangledown, size=size.small)

// ============================================================================
// –¢–ê–ë–õ–ò–¶–ê –ò–ù–§–û–†–ú–ê–¶–ò–ò / INFO TABLE
// ============================================================================
// –°–æ–≥–ª–∞—Å–Ω–æ issue #59: —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ (overlay indicator),
// –∞ –Ω–µ –Ω–∞ –ø–∞–Ω–µ–ª–∏ –≤–Ω–∏–∑—É. –¢–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ bgakkclod_v3_indicator.pine
// According to issue #59: table should be on chart (overlay indicator),
// not on the bottom panel. Table moved to bgakkclod_v3_indicator.pine

// ============================================================================
// –ê–õ–ï–†–¢–´ / ALERTS
// ============================================================================

alertcondition(bullishSignal, "Bullish Signal",
               "BGAKKCLOD v3 Panel: Bullish reversal signal detected!")

alertcondition(bearishSignal, "Bearish Signal",
               "BGAKKCLOD v3 Panel: Bearish reversal signal detected!")
