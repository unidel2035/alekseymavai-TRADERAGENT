// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TRADERAGENT

//@version=6
indicator("Universal Indicator - Fibonacci Overlay", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================================================
// INPUTS
// ============================================================================

// RSI Settings (must match the main indicator)
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI Settings")
rsiSmoothLength = input.int(3, "RSI Smoothing Length", minval=1, group="RSI Settings")
rsiOversold = input.int(30, "RSI Oversold Level", minval=1, maxval=50, group="RSI Settings")
rsiOverbought = input.int(70, "RSI Overbought Level", minval=50, maxval=100, group="RSI Settings")

// Volume-Momentum Settings (must match the main indicator)
volumeMaLength = input.int(20, "Volume MA Length", minval=1, group="Momentum Settings")
momentumThreshold = input.float(1.2, "Momentum Threshold", minval=1.0, step=0.1, group="Momentum Settings")

// Fibonacci Settings
fibLookback = input.int(100, "Fibonacci Lookback Period", minval=10, group="Fibonacci Settings")
showBullishFib = input.bool(true, "Show Bullish Fibonacci", group="Fibonacci Settings")
showBearishFib = input.bool(true, "Show Bearish Fibonacci", group="Fibonacci Settings")
showLabels = input.bool(true, "Show Level Labels", group="Fibonacci Settings")

// Display Settings
showBullishMarkers = input.bool(true, "Show Bullish Candle Markers", group="Display Settings")
showBearishMarkers = input.bool(true, "Show Bearish Candle Markers", group="Display Settings")

// ============================================================================
// INDICATOR CALCULATIONS (same as main indicator)
// ============================================================================

// RSI Calculation
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// Volume Momentum
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa

// State Detection
isOversold = rsi < rsiOversold
isOverbought = rsi > rsiOverbought

// Momentum Confirmation
strongMomentum = volumeMomentum > momentumThreshold

// ============================================================================
// SIGNAL DETECTION LOGIC
// ============================================================================

// Bullish Signal
bullishTransition = ta.crossover(rsi, rsiOversold)
rsiRising = rsiSmooth > rsiSmooth[1]
bullishSignal = bullishTransition and strongMomentum and rsiRising

// Bearish Signal
bearishTransition = ta.crossunder(rsi, rsiOverbought)
rsiFalling = rsiSmooth < rsiSmooth[1]
bearishSignal = bearishTransition and strongMomentum and rsiFalling

// ============================================================================
// FIBONACCI LEVELS MANAGEMENT
// ============================================================================

// Variables to store Fibonacci line and label arrays
var line[] bullishLines = array.new<line>()
var label[] bullishLabels = array.new<label>()
var line[] bearishLines = array.new<line>()
var label[] bearishLabels = array.new<label>()

// Function to delete old lines and labels
deleteOldFibonacci(line[] lines, label[] labels) =>
    if array.size(lines) > 0
        for i = array.size(lines) - 1 to 0
            line.delete(array.get(lines, i))
        array.clear(lines)
    if array.size(labels) > 0
        for i = array.size(labels) - 1 to 0
            label.delete(array.get(labels, i))
        array.clear(labels)

// Function to draw Fibonacci levels
drawFibonacci(float lowPrice, float highPrice, int signalBar, bool isBullish, color levelColor) =>
    if not na(lowPrice) and not na(highPrice) and (highPrice - lowPrice) > 0
        fibRange = highPrice - lowPrice

        // Define Fibonacci levels
        levels = array.from(0.0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0)
        levelNames = array.from("0%", "23.6%", "38.2%", "50%", "61.8%", "78.6%", "100%")
        levelColors = array.from(
             color.new(color.red, 30),
             color.new(color.orange, 30),
             color.new(color.yellow, 30),
             color.new(color.blue, 20),
             color.new(color.green, 20),
             color.new(color.purple, 30),
             color.new(color.red, 30)
         )
        levelWidths = array.from(2, 1, 1, 2, 2, 1, 2)

        // Draw each level
        for i = 0 to array.size(levels) - 1
            levelRatio = array.get(levels, i)
            levelPrice = isBullish ? lowPrice + fibRange * levelRatio : highPrice - fibRange * levelRatio
            levelName = array.get(levelNames, i)
            lineColor = array.get(levelColors, i)
            lineWidth = array.get(levelWidths, i)

            // Create line extending to the right
            newLine = line.new(
                 x1=signalBar,
                 y1=levelPrice,
                 x2=signalBar + 50,
                 y2=levelPrice,
                 color=lineColor,
                 width=lineWidth,
                 extend=extend.right
             )

            // Add line to appropriate array
            if isBullish
                array.push(bullishLines, newLine)
            else
                array.push(bearishLines, newLine)

            // Create label if enabled
            if showLabels
                labelText = levelName + " (" + str.tostring(levelPrice, format.mintick) + ")"
                labelColor = isBullish ? color.new(color.green, 70) : color.new(color.red, 70)

                newLabel = label.new(
                     x=signalBar,
                     y=levelPrice,
                     text=labelText,
                     style=label.style_label_left,
                     color=labelColor,
                     textcolor=color.white,
                     size=size.small
                 )

                // Add label to appropriate array
                if isBullish
                    array.push(bullishLabels, newLabel)
                else
                    array.push(bearishLabels, newLabel)

// Handle bullish signals
if bullishSignal and showBullishFib
    // Delete old bullish Fibonacci levels
    deleteOldFibonacci(bullishLines, bullishLabels)

    // Find swing points
    swingLow = ta.lowest(low, fibLookback)
    swingHigh = ta.highest(high, fibLookback)

    // Draw new Fibonacci levels
    drawFibonacci(swingLow, swingHigh, bar_index, true, color.green)

// Handle bearish signals
if bearishSignal and showBearishFib
    // Delete old bearish Fibonacci levels
    deleteOldFibonacci(bearishLines, bearishLabels)

    // Find swing points
    swingLow = ta.lowest(low, fibLookback)
    swingHigh = ta.highest(high, fibLookback)

    // Draw new Fibonacci levels
    drawFibonacci(swingLow, swingHigh, bar_index, false, color.red)

// ============================================================================
// CANDLE MARKERS
// ============================================================================

// Mark the signal candles
plotshape(
     showBullishMarkers and bullishSignal,
     title="Bullish Signal Candle",
     location=location.belowbar,
     color=color.new(color.green, 0),
     style=shape.triangleup,
     size=size.normal,
     text="BUY"
 )

plotshape(
     showBearishMarkers and bearishSignal,
     title="Bearish Signal Candle",
     location=location.abovebar,
     color=color.new(color.red, 0),
     style=shape.triangledown,
     size=size.normal,
     text="SELL"
 )

// Highlight signal candles with background color
barcolor(bullishSignal and showBullishMarkers ? color.new(color.green, 70) : na, title="Bullish Candle")
barcolor(bearishSignal and showBearishMarkers ? color.new(color.red, 70) : na, title="Bearish Candle")

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(bullishSignal, "Bullish Fibonacci Signal", "Bullish signal with Fibonacci levels drawn")
alertcondition(bearishSignal, "Bearish Fibonacci Signal", "Bearish signal with Fibonacci levels drawn")
