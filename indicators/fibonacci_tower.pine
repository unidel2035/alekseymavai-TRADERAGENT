// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TRADERAGENT

//@version=6
indicator("Fibonacci Tower", overlay=true, max_lines_count=500)

// ============================================================================
// INPUTS
// ============================================================================

// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI Settings")
rsiOversold = input.int(30, "RSI Oversold Level", minval=1, maxval=50, group="RSI Settings")

// MACD Settings
macdFastLength = input.int(12, "MACD Fast Length", minval=1, group="MACD Settings")
macdSlowLength = input.int(26, "MACD Slow Length", minval=1, group="MACD Settings")
macdSignalLength = input.int(9, "MACD Signal Length", minval=1, group="MACD Settings")

// Fibonacci Settings
fibLookback = input.int(100, "Fibonacci Lookback Period", minval=10, group="Fibonacci Settings")
showFibLevels = input.bool(true, "Show Fibonacci Levels", group="Fibonacci Settings")

// Signal Display Settings
showBuySignals = input.bool(true, "Show Buy Signals", group="Display Settings")
showLabels = input.bool(true, "Show Level Labels", group="Display Settings")

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

// RSI Calculation
rsi = ta.rsi(close, rsiLength)
rsiOversoldCondition = rsi < rsiOversold

// MACD Calculation
[macdLine, signalLine, histLine] = ta.macd(close, macdFastLength, macdSlowLength, macdSignalLength)
macdBullishCross = ta.crossover(macdLine, signalLine)
macdReversal = macdBullishCross and histLine[1] < 0

// Bearish Candles Detection (3 consecutive bearish candles)
bearishCandle = close < open
threeBearishCandles = bearishCandle and bearishCandle[1] and bearishCandle[2]

// ============================================================================
// BUY SIGNAL LOGIC
// ============================================================================

// Combine all conditions for buy signal
buySignal = threeBearishCandles and rsiOversoldCondition and macdReversal

// ============================================================================
// FIBONACCI LEVELS CALCULATION
// ============================================================================

// Find swing high and low within lookback period
var float swingHigh = na
var float swingLow = na
var int swingHighBar = na
var int swingLowBar = na
var bool fibLevelsActive = false
var int totalBuySignals = 0

// Update swing points when buy signal occurs
if buySignal
    // Increment signal counter for debugging
    totalBuySignals += 1

    // Find highest high and lowest low in lookback period
    float tempHigh = ta.highest(high, fibLookback)
    float tempLow = ta.lowest(low, fibLookback)

    // Validate that swing points are valid and range is positive
    if not na(tempHigh) and not na(tempLow) and (tempHigh - tempLow) > 0
        swingHigh := tempHigh
        swingLow := tempLow
        swingHighBar := bar_index
        swingLowBar := bar_index
        fibLevelsActive := true

// Calculate Fibonacci levels safely (only when we have valid swing points)
fibRange = (not na(swingHigh) and not na(swingLow)) ? swingHigh - swingLow : 0.0
fib0 = not na(swingLow) ? swingLow : close
fib236 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.236 : close
fib382 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.382 : close
fib50 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.500 : close
fib618 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.618 : close
fib786 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.786 : close
fib100 = not na(swingHigh) ? swingHigh : close

// ============================================================================
// VISUALIZATION
// ============================================================================

// Plot Buy Signals
plotshape(
     showBuySignals and buySignal,
     title="Buy Signal",
     location=location.belowbar,
     color=color.new(color.green, 0),
     style=shape.triangleup,
     size=size.normal,
     text="BUY"
 )

// Plot Fibonacci Levels
var line fibLine0 = na
var line fibLine236 = na
var line fibLine382 = na
var line fibLine50 = na
var line fibLine618 = na
var line fibLine786 = na
var line fibLine100 = na

var label fibLabel0 = na
var label fibLabel236 = na
var label fibLabel382 = na
var label fibLabel50 = na
var label fibLabel618 = na
var label fibLabel786 = na
var label fibLabel100 = na

// Draw Fibonacci lines only when we have a valid buy signal and active levels
if buySignal and showFibLevels and fibLevelsActive and fibRange > 0
    // Delete old lines and labels safely
    if not na(fibLine0)
        line.delete(fibLine0)
    if not na(fibLine236)
        line.delete(fibLine236)
    if not na(fibLine382)
        line.delete(fibLine382)
    if not na(fibLine50)
        line.delete(fibLine50)
    if not na(fibLine618)
        line.delete(fibLine618)
    if not na(fibLine786)
        line.delete(fibLine786)
    if not na(fibLine100)
        line.delete(fibLine100)

    if not na(fibLabel0)
        label.delete(fibLabel0)
    if not na(fibLabel236)
        label.delete(fibLabel236)
    if not na(fibLabel382)
        label.delete(fibLabel382)
    if not na(fibLabel50)
        label.delete(fibLabel50)
    if not na(fibLabel618)
        label.delete(fibLabel618)
    if not na(fibLabel786)
        label.delete(fibLabel786)
    if not na(fibLabel100)
        label.delete(fibLabel100)

    // Draw new Fibonacci lines with enhanced visibility
    fibLine0 := line.new(bar_index, fib0, bar_index + 1, fib0,
        color=color.new(color.red, 0),
        width=2,
        style=line.style_solid,
        extend=extend.right)

    fibLine236 := line.new(bar_index, fib236, bar_index + 1, fib236,
        color=color.new(color.orange, 0),
        width=2,
        style=line.style_solid,
        extend=extend.right)

    fibLine382 := line.new(bar_index, fib382, bar_index + 1, fib382,
        color=color.new(color.yellow, 0),
        width=2,
        style=line.style_solid,
        extend=extend.right)

    fibLine50 := line.new(bar_index, fib50, bar_index + 1, fib50,
        color=color.new(color.blue, 0),
        width=3,
        style=line.style_solid,
        extend=extend.right)

    fibLine618 := line.new(bar_index, fib618, bar_index + 1, fib618,
        color=color.new(color.green, 0),
        width=2,
        style=line.style_solid,
        extend=extend.right)

    fibLine786 := line.new(bar_index, fib786, bar_index + 1, fib786,
        color=color.new(color.purple, 0),
        width=2,
        style=line.style_solid,
        extend=extend.right)

    fibLine100 := line.new(bar_index, fib100, bar_index + 1, fib100,
        color=color.new(color.red, 0),
        width=2,
        style=line.style_solid,
        extend=extend.right)

    // Add labels if enabled
    if showLabels
        fibLabel0 := label.new(bar_index, fib0, "0.0% (Tower Base)",
            style=label.style_label_left,
            color=color.new(color.red, 70),
            textcolor=color.white,
            size=size.normal,
            textalign=text.align_left)

        fibLabel236 := label.new(bar_index, fib236, "23.6%",
            style=label.style_label_left,
            color=color.new(color.orange, 70),
            textcolor=color.white,
            size=size.normal,
            textalign=text.align_left)

        fibLabel382 := label.new(bar_index, fib382, "38.2%",
            style=label.style_label_left,
            color=color.new(color.yellow, 70),
            textcolor=color.black,
            size=size.normal,
            textalign=text.align_left)

        fibLabel50 := label.new(bar_index, fib50, "50.0%",
            style=label.style_label_left,
            color=color.new(color.blue, 70),
            textcolor=color.white,
            size=size.normal,
            textalign=text.align_left)

        fibLabel618 := label.new(bar_index, fib618, "61.8% (Golden Ratio)",
            style=label.style_label_left,
            color=color.new(color.green, 70),
            textcolor=color.white,
            size=size.normal,
            textalign=text.align_left)

        fibLabel786 := label.new(bar_index, fib786, "78.6%",
            style=label.style_label_left,
            color=color.new(color.purple, 70),
            textcolor=color.white,
            size=size.normal,
            textalign=text.align_left)

        fibLabel100 := label.new(bar_index, fib100, "100.0% (Tower Top)",
            style=label.style_label_left,
            color=color.new(color.red, 70),
            textcolor=color.white,
            size=size.normal,
            textalign=text.align_left)

// ============================================================================
// ALERTS
// ============================================================================

// Alert condition for buy signals
alertcondition(buySignal, title="Fibonacci Tower Buy Signal", message="Fibonacci Tower: Buy signal detected! 3 bearish candles + RSI oversold + MACD reversal")

// Background highlighting for buy signals
bgcolor(buySignal ? color.new(color.green, 90) : na, title="Buy Signal Background")

// ============================================================================
// DEBUG TABLE FOR USER FEEDBACK
// ============================================================================

// Create debug table to show indicator status
var table debugTable = table.new(position.top_right, 2, 6, border_width=1)

if barstate.islast
    // Row 0: Buy Signals Count
    table.cell(debugTable, 0, 0, "Buy Signals",
        bgcolor=color.new(color.gray, 70),
        text_color=color.white,
        text_size=size.normal)
    table.cell(debugTable, 1, 0, str.tostring(totalBuySignals),
        bgcolor=totalBuySignals > 0 ? color.new(color.green, 70) : color.new(color.red, 70),
        text_color=color.white,
        text_size=size.large)

    // Row 1: Current RSI
    table.cell(debugTable, 0, 1, "RSI",
        bgcolor=color.new(color.gray, 70),
        text_color=color.white,
        text_size=size.normal)
    table.cell(debugTable, 1, 1, str.tostring(math.round(rsi, 2)),
        bgcolor=rsiOversoldCondition ? color.new(color.green, 70) : color.new(color.gray, 80),
        text_color=color.white,
        text_size=size.normal)

    // Row 2: Fibonacci Active Status
    table.cell(debugTable, 0, 2, "Fib Active",
        bgcolor=color.new(color.gray, 70),
        text_color=color.white,
        text_size=size.normal)
    table.cell(debugTable, 1, 2, fibLevelsActive ? "YES" : "NO",
        bgcolor=fibLevelsActive ? color.new(color.green, 70) : color.new(color.orange, 70),
        text_color=color.white,
        text_size=size.normal)

    // Row 3: Swing Range
    table.cell(debugTable, 0, 3, "Swing Range",
        bgcolor=color.new(color.gray, 70),
        text_color=color.white,
        text_size=size.normal)
    table.cell(debugTable, 1, 3, fibRange > 0 ? str.tostring(math.round(fibRange, 4)) : "N/A",
        bgcolor=color.new(color.gray, 80),
        text_color=color.white,
        text_size=size.small)

    // Row 4: 3 Bearish Candles
    table.cell(debugTable, 0, 4, "3 Bearish",
        bgcolor=color.new(color.gray, 70),
        text_color=color.white,
        text_size=size.normal)
    table.cell(debugTable, 1, 4, threeBearishCandles ? "YES" : "NO",
        bgcolor=threeBearishCandles ? color.new(color.green, 70) : color.new(color.gray, 80),
        text_color=color.white,
        text_size=size.normal)

    // Row 5: Status Message
    table.cell(debugTable, 0, 5, "Status",
        bgcolor=color.new(color.gray, 70),
        text_color=color.white,
        text_size=size.normal)

    string statusMsg = totalBuySignals == 0 ? "No signals yet" :
                       fibLevelsActive ? "Lines drawn!" :
                       "Waiting..."

    table.cell(debugTable, 1, 5, statusMsg,
        bgcolor=color.new(color.blue, 70),
        text_color=color.white,
        text_size=size.normal)

// ============================================================================
// VISUAL CONDITION MARKERS
// ============================================================================

// Show when individual conditions are met (but not full signal)
plotchar(threeBearishCandles and not buySignal, char="3",
    location=location.abovebar,
    color=color.new(color.orange, 0),
    size=size.tiny,
    title="3 Bearish Candles")

plotchar(rsiOversoldCondition and not buySignal, char="R",
    location=location.belowbar,
    color=color.new(color.blue, 0),
    size=size.tiny,
    title="RSI Oversold")

plotchar(macdBullishCross, char="M",
    location=location.bottom,
    color=color.new(color.purple, 0),
    size=size.tiny,
    title="MACD Cross")

// ============================================================================
// PLOTS FOR DEBUGGING (Optional - can be commented out)
// ============================================================================

// Plot RSI in separate pane (optional)
// plot(rsi, "RSI", color=color.blue, display=display.none)
// hline(rsiOversold, "RSI Oversold", color=color.red, linestyle=hline.style_dotted, display=display.none)
