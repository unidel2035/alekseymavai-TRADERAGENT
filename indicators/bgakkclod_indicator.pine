// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
indicator("BGAKKCLOD - Универсальный индикатор определения свечей", shorttitle="BGAKKCLOD", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================================================
// ОПИСАНИЕ / DESCRIPTION
// ============================================================================
// BGAKKCLOD (Bullish/Bearish GAP Analysis Key Candle Level Overlay Detector)
//
// Комбинированный индикатор, объединяющий лучшие функции:
// - Fibonacci Tower: мультиусловная фильтрация сигналов
// - Universal Indicator v3: логарифмические уровни Фибоначчи
// - Traforetto Strategy: анализ геометрической силы тренда
//
// Combined indicator integrating best features from:
// - Fibonacci Tower: multi-condition signal filtering
// - Universal Indicator v3: logarithmic Fibonacci levels
// - Traforetto Strategy: geometric trend strength analysis
//
// Улучшения:
// - Расширенное определение бычьих и медвежьих свечей
// - Множественные точки входа с управлением рисками
// - Оценка силы сигнала
// - Дивергенция между ценой и RSI

// ============================================================================
// ВХОДНЫЕ ПАРАМЕТРЫ / INPUTS
// ============================================================================

// === RSI Settings / Настройки RSI ===
rsiLength = input.int(14, "RSI Period / Период RSI", minval=1, group="RSI Settings / Настройки RSI")
rsiSmoothLength = input.int(3, "RSI Smoothing / Сглаживание RSI", minval=1, group="RSI Settings / Настройки RSI")
rsiOversold = input.int(30, "Oversold Level / Перепроданность", minval=1, maxval=50, group="RSI Settings / Настройки RSI")
rsiOverbought = input.int(70, "Overbought Level / Перекупленность", minval=50, maxval=100, group="RSI Settings / Настройки RSI")
enableDivergence = input.bool(true, "Enable RSI Divergence / Дивергенция RSI", group="RSI Settings / Настройки RSI")

// === MACD Settings / Настройки MACD ===
macdFastLength = input.int(12, "MACD Fast Length / Быстрая", minval=1, group="MACD Settings / Настройки MACD")
macdSlowLength = input.int(26, "MACD Slow Length / Медленная", minval=1, group="MACD Settings / Настройки MACD")
macdSignalLength = input.int(9, "MACD Signal Length / Сигнальная", minval=1, group="MACD Settings / Настройки MACD")

// === Volume & Momentum Settings / Настройки объема и моментума ===
volumeMaLength = input.int(20, "Volume MA Period / Период MA объема", minval=1, group="Volume Settings / Настройки объема")
volumeThreshold = input.float(1.3, "Volume Threshold / Порог объема", minval=1.0, step=0.1, group="Volume Settings / Настройки объема")
momentumThreshold = input.float(1.2, "Momentum Threshold / Порог моментума", minval=1.0, step=0.1, group="Volume Settings / Настройки объема")

// === Candle Pattern Settings / Настройки свечных паттернов ===
enableEngulfing = input.bool(true, "Enable Engulfing Pattern / Паттерн поглощения", group="Candle Patterns / Свечные паттерны")
enableHammer = input.bool(true, "Enable Hammer/Shooting Star / Молот/Падающая звезда", group="Candle Patterns / Свечные паттерны")
enable3Candles = input.bool(true, "Enable 3 Consecutive Candles / 3 последовательные свечи", group="Candle Patterns / Свечные паттерны")
candleBodyRatio = input.float(0.6, "Min Body/Range Ratio / Мин. тело/диапазон", minval=0.1, maxval=0.9, step=0.1, group="Candle Patterns / Свечные паттерны")

// === Signal Filtering / Фильтрация сигналов ===
minBarsBetweenSignals = input.int(10, "Min Bars Between Signals / Мин. баров между сигналами", minval=1, group="Signal Filtering / Фильтр сигналов")
minSignalStrength = input.int(3, "Min Signal Strength (1-5) / Мин. сила сигнала", minval=1, maxval=5, group="Signal Filtering / Фильтр сигналов")

// === Fibonacci Settings / Настройки Фибоначчи ===
fibLookback = input.int(100, "Fibonacci Lookback / Период поиска", minval=10, group="Fibonacci Settings / Настройки Фибоначчи")
showFibLevels = input.bool(true, "Show Fibonacci Levels / Показать уровни", group="Fibonacci Settings / Настройки Фибоначчи")
showLabels = input.bool(true, "Show Level Labels / Метки уровней", group="Fibonacci Settings / Настройки Фибоначчи")
lineExtension = input.int(20, "Line Extension (bars) / Продление линий", minval=5, maxval=100, group="Fibonacci Settings / Настройки Фибоначчи")

// === Display Settings / Настройки отображения ===
showBullishSignals = input.bool(true, "Show Bullish Signals / Бычьи сигналы", group="Display Settings / Отображение")
showBearishSignals = input.bool(true, "Show Bearish Signals / Медвежьи сигналы", group="Display Settings / Отображение")
showSignalStrength = input.bool(true, "Show Signal Strength / Показать силу сигнала", group="Display Settings / Отображение")
showInfoTable = input.bool(true, "Show Info Table / Информационная таблица", group="Display Settings / Отображение")

// ============================================================================
// ВЫЧИСЛЕНИЕ ИНДИКАТОРОВ / INDICATOR CALCULATIONS
// ============================================================================

// === RSI ===
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)
rsiRising = rsiSmooth > rsiSmooth[1]
rsiFalling = rsiSmooth < rsiSmooth[1]

// === MACD ===
[macdLine, signalLine, histLine] = ta.macd(close, macdFastLength, macdSlowLength, macdSignalLength)
macdBullishCross = ta.crossover(macdLine, signalLine)
macdBearishCross = ta.crossunder(macdLine, signalLine)
macdBullish = macdBullishCross and histLine[1] < 0
macdBearish = macdBearishCross and histLine[1] > 0

// === Volume & Momentum ===
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa
strongVolume = volumeMomentum > volumeThreshold
strongMomentum = volumeMomentum > momentumThreshold

// ============================================================================
// УЛУЧШЕННОЕ ОПРЕДЕЛЕНИЕ СВЕЧНЫХ ПАТТЕРНОВ / ENHANCED CANDLE PATTERN DETECTION
// ============================================================================

// === Basic Candle Properties ===
candleBody = math.abs(close - open)
candleRange = high - low
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low

isBullishCandle = close > open
isBearishCandle = close < open

// === Strong Body Candle ===
hasStrongBody = candleBody >= (candleRange * candleBodyRatio)

// === Bullish Patterns ===
// 1. Bullish Engulfing / Бычье поглощение
bullishEngulfing = enableEngulfing and
     isBullishCandle and
     isBearishCandle[1] and
     close > open[1] and
     open < close[1] and
     hasStrongBody

// 2. Hammer / Молот (длинная нижняя тень, маленькое тело сверху)
isHammer = enableHammer and
     lowerWick > (candleBody * 2) and
     upperWick < (candleBody * 0.3) and
     candleBody > 0

// 3. Three Consecutive Bearish then Reversal / 3 медвежьи, затем разворот
threeBearish = enable3Candles and
     isBearishCandle and
     isBearishCandle[1] and
     isBearishCandle[2]

// === Bearish Patterns ===
// 1. Bearish Engulfing / Медвежье поглощение
bearishEngulfing = enableEngulfing and
     isBearishCandle and
     isBullishCandle[1] and
     close < open[1] and
     open > close[1] and
     hasStrongBody

// 2. Shooting Star / Падающая звезда (длинная верхняя тень)
isShootingStar = enableHammer and
     upperWick > (candleBody * 2) and
     lowerWick < (candleBody * 0.3) and
     candleBody > 0

// 3. Three Consecutive Bullish then Reversal / 3 бычьи, затем разворот
threeBullish = enable3Candles and
     isBullishCandle and
     isBullishCandle[1] and
     isBullishCandle[2]

// ============================================================================
// ОПРЕДЕЛЕНИЕ ДИВЕРГЕНЦИЙ / DIVERGENCE DETECTION
// ============================================================================

// Simplified divergence detection
// Бычья дивергенция: цена делает новый минимум, но RSI - нет
lookbackDivergence = 10
bullishDivergence = enableDivergence and
     low < ta.lowest(low[1], lookbackDivergence) and
     rsi > ta.lowest(rsi[1], lookbackDivergence)

// Медвежья дивергенция: цена делает новый максимум, но RSI - нет
bearishDivergence = enableDivergence and
     high > ta.highest(high[1], lookbackDivergence) and
     rsi < ta.highest(rsi[1], lookbackDivergence)

// ============================================================================
// ОЦЕНКА СИЛЫ СИГНАЛА / SIGNAL STRENGTH SCORING
// ============================================================================

// Функция для подсчета силы бычьего сигнала (1-5)
calcBullishStrength() =>
    int strength = 0

    // 1. RSI условия
    if rsi < rsiOversold and rsiRising
        strength += 1

    // 2. MACD разворот
    if macdBullish
        strength += 1

    // 3. Объем
    if strongVolume
        strength += 1

    // 4. Свечной паттерн
    if bullishEngulfing or isHammer or (threeBearish and isBullishCandle)
        strength += 1

    // 5. Дивергенция
    if bullishDivergence
        strength += 1

    strength

// Функция для подсчета силы медвежьего сигнала (1-5)
calcBearishStrength() =>
    int strength = 0

    // 1. RSI условия
    if rsi > rsiOverbought and rsiFalling
        strength += 1

    // 2. MACD разворот
    if macdBearish
        strength += 1

    // 3. Объем
    if strongVolume
        strength += 1

    // 4. Свечной паттерн
    if bearishEngulfing or isShootingStar or (threeBullish and isBearishCandle)
        strength += 1

    // 5. Дивергенция
    if bearishDivergence
        strength += 1

    strength

// ============================================================================
// ГЕНЕРАЦИЯ СИГНАЛОВ / SIGNAL GENERATION
// ============================================================================

// Calculate signal strength / Вычисление силы сигнала
bullishStrength = calcBullishStrength()
bearishStrength = calcBearishStrength()

// Raw signals based on strength / Сырые сигналы на основе силы
bullishSignalRaw = bullishStrength >= minSignalStrength
bearishSignalRaw = bearishStrength >= minSignalStrength

// Filter signals by minimum bars between them
// Фильтр сигналов по минимальному расстоянию
var int lastSignalBar = na
signalAllowed = na(lastSignalBar) or (bar_index - lastSignalBar) >= minBarsBetweenSignals

// Final signals / Финальные сигналы
bullishSignal = bullishSignalRaw and signalAllowed and showBullishSignals
bearishSignal = bearishSignalRaw and signalAllowed and showBearishSignals

// Update last signal bar / Обновление последнего бара сигнала
if bullishSignal or bearishSignal
    lastSignalBar := bar_index

// ============================================================================
// FIBONACCI LEVELS - ЛОГАРИФМИЧЕСКАЯ ШКАЛА / LOGARITHMIC FIBONACCI
// ============================================================================

// Storage for active Fibonacci levels
// Хранилище для активных уровней Фибоначчи
var line[] activeFibLines = array.new<line>()
var label[] activeFibLabels = array.new<label>()

// Store last signal data for table display
// Хранение данных последнего сигнала для таблицы
var string lastSignalType = "none"
var float lastLowPrice = na
var float lastHighPrice = na
var int lastSignalStrengthValue = 0

// Function to delete old Fibonacci objects
// Функция удаления старых объектов Фибоначчи
deleteOldFibonacci() =>
    // Delete lines
    if array.size(activeFibLines) > 0
        for i = array.size(activeFibLines) - 1 to 0
            line.delete(array.get(activeFibLines, i))
        array.clear(activeFibLines)

    // Delete labels
    if array.size(activeFibLabels) > 0
        for i = array.size(activeFibLabels) - 1 to 0
            label.delete(array.get(activeFibLabels, i))
        array.clear(activeFibLabels)

// Function to calculate logarithmic Fibonacci price
// Функция вычисления логарифмической цены Фибоначчи
calcLogFibPrice(float lowPrice, float highPrice, float level) =>
    float result = na
    if not na(lowPrice) and not na(highPrice) and lowPrice > 0 and highPrice > 0 and highPrice > lowPrice
        logLow = math.log(lowPrice)
        logHigh = math.log(highPrice)
        logRange = logHigh - logLow

        // Declare logPrice variable before using it
        float logPrice = na

        // level 0.0 = High, level 1.0 = Low
        // Negative levels go above High (take profits)
        logPrice := logHigh - (logRange * level)
        result := math.exp(logPrice)
    result

// Function to draw Fibonacci levels
// Функция отрисовки уровней Фибоначчи
drawFibonacci(float candleLow, float candleHigh, int signalBar, bool isBullish) =>
    if not na(candleLow) and not na(candleHigh) and candleLow > 0 and candleHigh > 0 and candleHigh > candleLow

        // Define Fibonacci levels
        // Определение уровней Фибоначчи
        levels = array.from(-2.618, -1.618, -0.618, 0.0, 0.382, 0.5, 0.618, 0.786, 1.0)

        levelNames = array.from(
             "TP3 (-261.8%)",
             "TP2 (-161.8%)",
             "TP1 (-61.8%)",
             "Entry Zone (0%)",
             "Add Position (38.2%)",
             "Add Position (50%)",
             "Add Position (61.8%)",
             "STOP LOSS (78.6%)",
             "Base (100%)"
         )

        levelAnnotations = array.from(
             "Закрыть 40%",
             "Закрыть 30%",
             "Закрыть 30%",
             isBullish ? "Лонг вход" : "Шорт вход",
             "Лимитка 1%",
             "Лимитка 1%",
             "Лимитка 1%",
             "Стоп-лосс",
             "Основание"
         )

        // Color scheme
        // Цветовая схема
        levelColors = array.from(
             color.new(#00FF00, 20),    // TP3 - bright green
             color.new(#00DD00, 20),    // TP2 - green
             color.new(#00AA00, 20),    // TP1 - dark green
             color.new(#FF6600, 0),     // Entry - orange
             color.new(#FFFF00, 20),    // Add 38.2% - yellow
             color.new(#FFD700, 20),    // Add 50% - gold
             color.new(#FFA500, 20),    // Add 61.8% - orange-gold
             color.new(#FF0000, 0),     // STOP - red
             color.new(#0066FF, 20)     // Base - blue
         )

        levelWidths = array.from(2, 2, 2, 3, 2, 2, 2, 3, 3)

        // Draw each level
        // Отрисовка каждого уровня
        for i = 0 to array.size(levels) - 1
            levelRatio = array.get(levels, i)
            levelPrice = calcLogFibPrice(candleLow, candleHigh, levelRatio)

            if not na(levelPrice) and levelPrice > 0
                levelName = array.get(levelNames, i)
                annotation = array.get(levelAnnotations, i)
                lineColor = array.get(levelColors, i)
                lineWidth = array.get(levelWidths, i)

                // Create line
                newLine = line.new(
                     x1=signalBar,
                     y1=levelPrice,
                     x2=signalBar + lineExtension,
                     y2=levelPrice,
                     color=lineColor,
                     width=lineWidth,
                     style=line.style_solid
                 )

                array.push(activeFibLines, newLine)

                // Create label
                if showLabels
                    labelText = levelName + "\n" + annotation
                    labelBgColor = isBullish ? color.new(color.green, 70) : color.new(color.red, 70)

                    newLabel = label.new(
                         x=signalBar,
                         y=levelPrice,
                         text=labelText,
                         style=label.style_label_left,
                         color=labelBgColor,
                         textcolor=color.white,
                         size=size.small
                     )

                    array.push(activeFibLabels, newLabel)

// ============================================================================
// ОБРАБОТКА СИГНАЛОВ / SIGNAL HANDLING
// ============================================================================

// Handle bullish signals / Обработка бычьих сигналов
if bullishSignal and showFibLevels
    deleteOldFibonacci()

    // Find swing points in lookback period
    // Поиск точек разворота в периоде lookback
    swingLow = ta.lowest(low, fibLookback)
    swingHigh = ta.highest(high, fibLookback)

    // Draw Fibonacci from Low to High
    // Отрисовка Фибоначчи от Low до High
    drawFibonacci(swingLow, swingHigh, bar_index, true)

    // Store for table
    lastSignalType := "BULLISH"
    lastLowPrice := swingLow
    lastHighPrice := swingHigh
    lastSignalStrengthValue := bullishStrength

// Handle bearish signals / Обработка медвежьих сигналов
if bearishSignal and showFibLevels
    deleteOldFibonacci()

    // Find swing points in lookback period
    // Поиск точек разворота в периоде lookback
    swingLow = ta.lowest(low, fibLookback)
    swingHigh = ta.highest(high, fibLookback)

    // Draw Fibonacci from High to Low (for short)
    // Отрисовка Фибоначчи от High до Low (для шорта)
    drawFibonacci(swingLow, swingHigh, bar_index, false)

    // Store for table
    lastSignalType := "BEARISH"
    lastLowPrice := swingLow
    lastHighPrice := swingHigh
    lastSignalStrengthValue := bearishStrength

// ============================================================================
// ВИЗУАЛИЗАЦИЯ СИГНАЛОВ / SIGNAL VISUALIZATION
// ============================================================================

// Bullish signal markers / Маркеры бычьих сигналов
signalText = showSignalStrength ? str.tostring(bullishStrength) + "★" : "BUY"
plotshape(
     bullishSignal,
     title="Bullish Signal / Бычий сигнал",
     location=location.belowbar,
     color=color.new(color.green, 0),
     style=shape.triangleup,
     size=size.normal,
     text=signalText
 )

// Bearish signal markers / Маркеры медвежьих сигналов
signalTextBearish = showSignalStrength ? str.tostring(bearishStrength) + "★" : "SELL"
plotshape(
     bearishSignal,
     title="Bearish Signal / Медвежий сигнал",
     location=location.abovebar,
     color=color.new(color.red, 0),
     style=shape.triangledown,
     size=size.normal,
     text=signalTextBearish
 )

// Highlight signal candles / Подсветка сигнальных свечей
barcolor(
     bullishSignal ? color.new(color.green, 70) :
     bearishSignal ? color.new(color.red, 70) : na,
     title="Signal Candle Highlight / Подсветка сигнальной свечи"
 )

// ============================================================================
// ИНФОРМАЦИОННАЯ ТАБЛИЦА / INFO TABLE
// ============================================================================

var table infoTable = table.new(position.top_right, 2, 8, border_width=1)

if showInfoTable and barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "BGAKKCLOD",
        bgcolor=color.new(color.blue, 50),
        text_color=color.white,
        text_size=size.normal)
    table.cell(infoTable, 1, 0, "Status",
        bgcolor=color.new(color.blue, 50),
        text_color=color.white,
        text_size=size.normal)

    // Last Signal Type
    table.cell(infoTable, 0, 1, "Last Signal",
        bgcolor=color.new(color.gray, 70),
        text_size=size.small)
    signalColor = lastSignalType == "BULLISH" ? color.new(color.green, 70) :
                  lastSignalType == "BEARISH" ? color.new(color.red, 70) :
                  color.new(color.gray, 70)
    table.cell(infoTable, 1, 1, lastSignalType,
        bgcolor=signalColor,
        text_color=color.white,
        text_size=size.small)

    // Signal Strength
    table.cell(infoTable, 0, 2, "Strength",
        bgcolor=color.new(color.gray, 70),
        text_size=size.small)
    strengthColor = lastSignalStrengthValue >= 4 ? color.new(color.green, 70) :
                    lastSignalStrengthValue >= 3 ? color.new(color.orange, 70) :
                    color.new(color.red, 70)
    table.cell(infoTable, 1, 2, str.tostring(lastSignalStrengthValue) + "/5",
        bgcolor=strengthColor,
        text_color=color.white,
        text_size=size.small)

    // Current RSI
    table.cell(infoTable, 0, 3, "RSI",
        bgcolor=color.new(color.gray, 70),
        text_size=size.small)
    rsiColor = rsi < rsiOversold ? color.new(color.green, 70) :
               rsi > rsiOverbought ? color.new(color.red, 70) :
               color.new(color.gray, 80)
    table.cell(infoTable, 1, 3, str.tostring(math.round(rsi, 1)),
        bgcolor=rsiColor,
        text_color=color.white,
        text_size=size.small)

    // Volume Momentum
    table.cell(infoTable, 0, 4, "Volume",
        bgcolor=color.new(color.gray, 70),
        text_size=size.small)
    volColor = strongVolume ? color.new(color.green, 70) : color.new(color.gray, 80)
    table.cell(infoTable, 1, 4, str.tostring(math.round(volumeMomentum, 2)) + "x",
        bgcolor=volColor,
        text_color=color.white,
        text_size=size.small)

    // Divergence Status
    table.cell(infoTable, 0, 5, "Divergence",
        bgcolor=color.new(color.gray, 70),
        text_size=size.small)
    divStatus = bullishDivergence ? "BULL" :
                bearishDivergence ? "BEAR" :
                "NONE"
    divColor = bullishDivergence ? color.new(color.green, 70) :
               bearishDivergence ? color.new(color.red, 70) :
               color.new(color.gray, 80)
    table.cell(infoTable, 1, 5, divStatus,
        bgcolor=divColor,
        text_color=color.white,
        text_size=size.small)

    // Fibonacci Range
    table.cell(infoTable, 0, 6, "Fib Range",
        bgcolor=color.new(color.gray, 70),
        text_size=size.small)
    fibRange = not na(lastHighPrice) and not na(lastLowPrice) ?
               math.round((lastHighPrice - lastLowPrice) / lastLowPrice * 100, 2) :
               0.0
    table.cell(infoTable, 1, 6, str.tostring(fibRange) + "%",
        bgcolor=color.new(color.gray, 80),
        text_color=color.white,
        text_size=size.small)

    // Risk/Reward (simplified)
    table.cell(infoTable, 0, 7, "R/R Est.",
        bgcolor=color.new(color.gray, 70),
        text_size=size.small)
    // Simple R/R: TP1 distance / Stop distance
    // Using -0.618 as TP1 and 0.786 as stop
    rrRatio = fibRange > 0 ? math.round((0.618 + 0.618) / (1 - 0.786), 2) : 0.0
    table.cell(infoTable, 1, 7, "1:" + str.tostring(rrRatio),
        bgcolor=color.new(color.blue, 70),
        text_color=color.white,
        text_size=size.small)

// ============================================================================
// АЛЕРТЫ / ALERTS
// ============================================================================

alertcondition(bullishSignal,
               "BGAKKCLOD Bullish Signal",
               "BGAKKCLOD: Бычий сигнал обнаружен! Сила: {{plot_0}}")

alertcondition(bearishSignal,
               "BGAKKCLOD Bearish Signal",
               "BGAKKCLOD: Медвежий сигнал обнаружен! Сила: {{plot_0}}")

alertcondition(bullishSignal and bullishStrength >= 4,
               "BGAKKCLOD Strong Bullish Signal",
               "BGAKKCLOD: СИЛЬНЫЙ бычий сигнал! Сила: {{plot_0}}/5")

alertcondition(bearishSignal and bearishStrength >= 4,
               "BGAKKCLOD Strong Bearish Signal",
               "BGAKKCLOD: СИЛЬНЫЙ медвежий сигнал! Сила: {{plot_0}}/5")

// ============================================================================
// ПРИМЕЧАНИЯ / NOTES
// ============================================================================
//
// BGAKKCLOD объединяет лучшие функции трех индикаторов:
//
// 1. От Fibonacci Tower:
//    - Мультиусловная фильтрация (RSI + MACD + свечи)
//    - Строгие критерии входа
//
// 2. От Universal Indicator v3:
//    - Логарифмические уровни Фибоначчи
//    - Двусторонние сигналы (Long и Short)
//    - Множественные точки входа
//
// 3. От Traforetto Strategy:
//    - Геометрический анализ силы тренда
//    - Оценка качества сигнала
//
// Улучшения:
// - Расширенные свечные паттерны (поглощение, молот, падающая звезда)
// - Определение дивергенций RSI
// - Система оценки силы сигнала (1-5 звезд)
// - Улучшенное управление рисками с расчетом R/R
// - Фильтрация по силе сигнала
//
// Рекомендации по использованию:
// - Минимальная сила сигнала 3/5 для начинающих
// - Минимальная сила сигнала 4/5 для опытных трейдеров
// - Используйте множественные точки входа (0%, 38.2%, 50%, 61.8%)
// - ВСЕГДА устанавливайте стоп-лосс на уровне 78.6%
// - Фиксируйте прибыль частями на TP1, TP2, TP3
