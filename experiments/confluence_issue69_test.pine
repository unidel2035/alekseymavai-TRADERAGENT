// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
indicator("Confluence Test - Issue #69", shorttitle="Confluence Test", overlay=false, max_boxes_count=50)

// ============================================================================
// ОПИСАНИЕ / DESCRIPTION
// ============================================================================
// Тестовый индикатор для проверки системы мультииндикаторного подтверждения
// (confluence) согласно issue #69.
//
// Test indicator for verifying multi-indicator confirmation system
// (confluence) according to issue #69.
//
// Этот индикатор позволяет визуально сравнить:
// 1. Оригинальную логику сигналов (RSI + Volume)
// 2. Логику confluence с настраиваемым минимальным баллом
// 3. Вклад каждого индикатора в общий балл
//
// This indicator allows visual comparison of:
// 1. Original signal logic (RSI + Volume)
// 2. Confluence logic with configurable minimum score
// 3. Contribution of each indicator to total score

// ============================================================================
// ВХОДНЫЕ ПАРАМЕТРЫ / INPUTS
// ============================================================================

// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI")
rsiOversold = input.int(30, "Oversold Level", minval=1, maxval=50, group="RSI")
rsiOverbought = input.int(70, "Overbought Level", minval=50, maxval=100, group="RSI")

// Volume Settings
volumeMaLength = input.int(20, "Volume MA Length", minval=1, group="Volume")
momentumThreshold = input.float(1.2, "Momentum Threshold", minval=1.0, step=0.1, group="Volume")

// Confluence Settings
enableConfluence = input.bool(true, "Enable Confluence", group="Confluence")
minConfluenceScore = input.int(4, "Min Confluence Score", minval=2, maxval=10, group="Confluence")

// Indicator Weights
rsiWeight = input.int(2, "RSI Weight", minval=0, maxval=5, group="Weights")
macdWeight = input.int(2, "MACD Weight", minval=0, maxval=5, group="Weights")
stochWeight = input.int(1, "Stochastic Weight", minval=0, maxval=5, group="Weights")
volumeWeight = input.int(2, "Volume Weight", minval=0, maxval=5, group="Weights")
priceActionWeight = input.int(1, "Price Action Weight", minval=0, maxval=5, group="Weights")
maWeight = input.int(1, "MA Weight", minval=0, maxval=5, group="Weights")

// ============================================================================
// ВЫЧИСЛЕНИЕ ИНДИКАТОРОВ / INDICATOR CALCULATIONS
// ============================================================================

// RSI
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, 3)

// Volume Momentum
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa
strongMomentum = volumeMomentum > momentumThreshold

// MACD
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)
macdBullish = ta.crossover(macdLine, signalLine) and macdLine < 0
macdBearish = ta.crossunder(macdLine, signalLine) and macdLine > 0

// Stochastic
stochK = ta.stoch(close, high, low, 14)
stochD = ta.sma(stochK, 3)
stochBullish = ta.crossover(stochK, stochD) and stochK < 20
stochBearish = ta.crossunder(stochK, stochD) and stochK > 80

// Price Action
candleRange = high - low
bullishCandle = (close - open) > (candleRange * 0.6) and candleRange > 0
bearishCandle = (open - close) > (candleRange * 0.6) and candleRange > 0

// Moving Averages
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
maBullish = ta.crossover(ema20, ema50)
maBearish = ta.crossunder(ema20, ema50)

// ============================================================================
// CONFLUENCE SCORE CALCULATION
// ============================================================================

var int bullishScore = 0
var int bearishScore = 0

bullishScore := 0
bearishScore := 0

// RSI Signal
rsiBullishSignal = ta.crossover(rsi, rsiOversold) and rsiSmooth > rsiSmooth[1]
rsiBearishSignal = ta.crossunder(rsi, rsiOverbought) and rsiSmooth < rsiSmooth[1]

if rsiBullishSignal
    bullishScore += rsiWeight
if rsiBearishSignal
    bearishScore += rsiWeight

// MACD Signal
if macdBullish
    bullishScore += macdWeight
if macdBearish
    bearishScore += macdWeight

// Stochastic Signal
if stochBullish
    bullishScore += stochWeight
if stochBearish
    bearishScore += stochWeight

// Volume Signal
volumeBullish = strongMomentum and close > open
volumeBearish = strongMomentum and close < open

if volumeBullish
    bullishScore += volumeWeight
if volumeBearish
    bearishScore += volumeWeight

// Price Action Signal
if bullishCandle
    bullishScore += priceActionWeight
if bearishCandle
    bearishScore += priceActionWeight

// MA Signal
if maBullish
    bullishScore += maWeight
if maBearish
    bearishScore += maWeight

// ============================================================================
// SIGNAL GENERATION
// ============================================================================

// Original signal (RSI + Volume only)
originalBullishSignal = rsiBullishSignal and strongMomentum
originalBearishSignal = rsiBearishSignal and strongMomentum

// Confluence signal (requires minimum score)
confluenceBullishSignal = bullishScore >= minConfluenceScore
confluenceBearishSignal = bearishScore >= minConfluenceScore

// Final signals based on mode
finalBullishSignal = enableConfluence ? confluenceBullishSignal : originalBullishSignal
finalBearishSignal = enableConfluence ? confluenceBearishSignal : originalBearishSignal

// ============================================================================
// VISUALIZATION
// ============================================================================

// Plot RSI
plot(rsi, "RSI", color=color.blue, linewidth=2)
hline(rsiOversold, "Oversold", color=color.green, linestyle=hline.style_dashed)
hline(rsiOverbought, "Overbought", color=color.red, linestyle=hline.style_dashed)
hline(50, "Midline", color=color.gray, linestyle=hline.style_dotted)

// Plot Volume Momentum (scaled to RSI range)
volumeMomentumScaled = (volumeMomentum - 1) * 50 + 50
plot(volumeMomentumScaled, "Volume Momentum", style=plot.style_histogram,
     color=volumeMomentum > momentumThreshold ? color.new(color.green, 50) : color.new(color.gray, 70))

// Plot Confluence Score (scaled to RSI range)
bullishScoreScaled = bullishScore * 5  // Scale to fit in RSI range
bearishScoreScaled = bearishScore * 5

plot(bullishScoreScaled, "Bullish Score", color=color.new(color.green, 50), linewidth=2, style=plot.style_line)
plot(bearishScoreScaled, "Bearish Score", color=color.new(color.red, 50), linewidth=2, style=plot.style_line)

// Plot threshold line
thresholdScaled = minConfluenceScore * 5
hline(thresholdScaled, "Confluence Threshold", color=color.orange, linestyle=hline.style_solid, linewidth=2)

// Signal markers
plotshape(finalBullishSignal, "Bullish Signal", location=location.bottom,
          color=color.new(color.green, 0), style=shape.triangleup, size=size.small)
plotshape(finalBearishSignal, "Bearish Signal", location=location.top,
          color=color.new(color.red, 0), style=shape.triangledown, size=size.small)

// Original signals (for comparison)
plotshape(not enableConfluence and originalBullishSignal, "Original Bullish", location=location.bottom,
          color=color.new(color.green, 70), style=shape.circle, size=size.tiny)
plotshape(not enableConfluence and originalBearishSignal, "Original Bearish", location=location.top,
          color=color.new(color.red, 70), style=shape.circle, size=size.tiny)

// ============================================================================
// COMPARISON TABLE
// ============================================================================

var table comparisonTable = table.new(position.top_right, 4, 10, border_width=1)

if barstate.islast
    // Header
    table.cell(comparisonTable, 0, 0, "Indicator", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)
    table.cell(comparisonTable, 1, 0, "Bull", bgcolor=color.new(color.green, 70), text_color=color.white, text_size=size.small)
    table.cell(comparisonTable, 2, 0, "Bear", bgcolor=color.new(color.red, 70), text_color=color.white, text_size=size.small)
    table.cell(comparisonTable, 3, 0, "Weight", bgcolor=color.new(color.gray, 70), text_color=color.white, text_size=size.small)

    // RSI
    table.cell(comparisonTable, 0, 1, "RSI", text_size=size.small)
    table.cell(comparisonTable, 1, 1, rsiBullishSignal ? "✓" : "−",
               bgcolor=rsiBullishSignal ? color.new(color.green, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 2, 1, rsiBearishSignal ? "✓" : "−",
               bgcolor=rsiBearishSignal ? color.new(color.red, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 3, 1, str.tostring(rsiWeight), text_size=size.small)

    // MACD
    table.cell(comparisonTable, 0, 2, "MACD", text_size=size.small)
    table.cell(comparisonTable, 1, 2, macdBullish ? "✓" : "−",
               bgcolor=macdBullish ? color.new(color.green, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 2, 2, macdBearish ? "✓" : "−",
               bgcolor=macdBearish ? color.new(color.red, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 3, 2, str.tostring(macdWeight), text_size=size.small)

    // Stochastic
    table.cell(comparisonTable, 0, 3, "Stochastic", text_size=size.small)
    table.cell(comparisonTable, 1, 3, stochBullish ? "✓" : "−",
               bgcolor=stochBullish ? color.new(color.green, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 2, 3, stochBearish ? "✓" : "−",
               bgcolor=stochBearish ? color.new(color.red, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 3, 3, str.tostring(stochWeight), text_size=size.small)

    // Volume
    table.cell(comparisonTable, 0, 4, "Volume", text_size=size.small)
    table.cell(comparisonTable, 1, 4, volumeBullish ? "✓" : "−",
               bgcolor=volumeBullish ? color.new(color.green, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 2, 4, volumeBearish ? "✓" : "−",
               bgcolor=volumeBearish ? color.new(color.red, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 3, 4, str.tostring(volumeWeight), text_size=size.small)

    // Price Action
    table.cell(comparisonTable, 0, 5, "Price Action", text_size=size.small)
    table.cell(comparisonTable, 1, 5, bullishCandle ? "✓" : "−",
               bgcolor=bullishCandle ? color.new(color.green, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 2, 5, bearishCandle ? "✓" : "−",
               bgcolor=bearishCandle ? color.new(color.red, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 3, 5, str.tostring(priceActionWeight), text_size=size.small)

    // MA Cross
    table.cell(comparisonTable, 0, 6, "MA Cross", text_size=size.small)
    table.cell(comparisonTable, 1, 6, maBullish ? "✓" : "−",
               bgcolor=maBullish ? color.new(color.green, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 2, 6, maBearish ? "✓" : "−",
               bgcolor=maBearish ? color.new(color.red, 70) : color.new(color.gray, 90), text_size=size.small)
    table.cell(comparisonTable, 3, 6, str.tostring(maWeight), text_size=size.small)

    // Separator
    table.cell(comparisonTable, 0, 7, "━━━━━━━━━━", text_color=color.gray, text_size=size.small)
    table.cell(comparisonTable, 1, 7, "━━━━━", text_color=color.gray, text_size=size.small)
    table.cell(comparisonTable, 2, 7, "━━━━━", text_color=color.gray, text_size=size.small)
    table.cell(comparisonTable, 3, 7, "━━━━━━", text_color=color.gray, text_size=size.small)

    // Total Score
    table.cell(comparisonTable, 0, 8, "TOTAL", bgcolor=color.new(color.blue, 80), text_color=color.white, text_size=size.small)
    table.cell(comparisonTable, 1, 8, str.tostring(bullishScore),
               bgcolor=bullishScore >= minConfluenceScore ? color.new(color.green, 50) : color.new(color.gray, 80),
               text_color=color.white, text_size=size.normal)
    table.cell(comparisonTable, 2, 8, str.tostring(bearishScore),
               bgcolor=bearishScore >= minConfluenceScore ? color.new(color.red, 50) : color.new(color.gray, 80),
               text_color=color.white, text_size=size.normal)
    table.cell(comparisonTable, 3, 8, "Threshold: " + str.tostring(minConfluenceScore),
               bgcolor=color.new(color.orange, 80), text_size=size.tiny)

    // Mode indicator
    modeText = enableConfluence ? "Confluence Mode" : "Original Mode"
    modeColor = enableConfluence ? color.new(color.blue, 70) : color.new(color.gray, 70)
    table.cell(comparisonTable, 0, 9, modeText, bgcolor=modeColor, text_color=color.white, text_size=size.small)

    // Signal status
    signalStatus = finalBullishSignal ? "BULLISH SIGNAL" : (finalBearishSignal ? "BEARISH SIGNAL" : "No Signal")
    signalColor = finalBullishSignal ? color.new(color.green, 50) : (finalBearishSignal ? color.new(color.red, 50) : color.new(color.gray, 80))
    table.cell(comparisonTable, 1, 9, signalStatus, bgcolor=signalColor, text_color=color.white, text_size=size.small)
    table.merge_cells(comparisonTable, 1, 9, 3, 9)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(finalBullishSignal, "Confluence Bullish Signal", "Confluence: Bullish signal detected!")
alertcondition(finalBearishSignal, "Confluence Bearish Signal", "Confluence: Bearish signal detected!")

// ============================================================================
// NOTES
// ============================================================================

// Использование / Usage:
// 1. Загрузите этот индикатор вместе с основным индикатором
//    Load this indicator alongside the main indicator
//
// 2. Включите/выключите режим confluence для сравнения
//    Enable/disable confluence mode for comparison
//
// 3. Настройте веса индикаторов под ваш стиль торговли
//    Adjust indicator weights for your trading style
//
// 4. Зеленые/красные линии показывают текущий балл confluence
//    Green/red lines show current confluence score
//
// 5. Оранжевая линия показывает порог для генерации сигнала
//    Orange line shows threshold for signal generation
