// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
indicator("Universal Indicator v3 Test", shorttitle="UI v3 Test", overlay=true)

// Test logarithmic Fibonacci calculations
// Тестирование расчетов логарифмических Фибоначчи

// Test parameters
testLow = input.float(100.0, "Test Candle Low", minval=0.01)
testHigh = input.float(110.0, "Test Candle High", minval=0.01)

// Function to calculate logarithmic Fibonacci price
calcLogFibPrice(float lowPrice, float highPrice, float level) =>
    float result = na
    if not na(lowPrice) and not na(highPrice) and lowPrice > 0 and highPrice > 0
        logLow = math.log(lowPrice)
        logHigh = math.log(highPrice)
        logRange = logHigh - logLow

        // level 0.0 = High, level 1.0 = Low
        // Negative levels go above High
        logPrice = logHigh - (logRange * level)

        result := math.exp(logPrice)
    result

// Calculate all levels
levels = array.from(-2.618, -1.618, -0.618, 0.0, 0.5, 0.618, 0.820, 1.0)
levelNames = array.from("TP3", "TP2", "TP1", "Entry #1", "Entry #2", "Entry #3", "STOP-LOSS", "Base")

// Create table to display results
var table testTable = table.new(position.top_left, 4, 9, border_width=1)

if barstate.islast
    // Header
    table.cell(testTable, 0, 0, "Level", text_color=color.white, bgcolor=color.new(color.gray, 30))
    table.cell(testTable, 1, 0, "Ratio", text_color=color.white, bgcolor=color.new(color.gray, 30))
    table.cell(testTable, 2, 0, "Price (Log)", text_color=color.white, bgcolor=color.new(color.gray, 30))
    table.cell(testTable, 3, 0, "Price (Linear)", text_color=color.white, bgcolor=color.new(color.gray, 30))

    // Input parameters
    table.cell(testTable, 0, array.size(levels) + 1, "Test Parameters:", text_color=color.yellow, bgcolor=color.new(color.blue, 70))
    table.cell(testTable, 1, array.size(levels) + 1, "Low: " + str.tostring(testLow), text_color=color.white, bgcolor=color.new(color.blue, 80))
    table.cell(testTable, 2, array.size(levels) + 1, "High: " + str.tostring(testHigh), text_color=color.white, bgcolor=color.new(color.blue, 80))
    table.cell(testTable, 3, array.size(levels) + 1, "Range: " + str.tostring(testHigh - testLow), text_color=color.white, bgcolor=color.new(color.blue, 80))

    // Calculate and display each level
    for i = 0 to array.size(levels) - 1
        levelRatio = array.get(levels, i)
        levelName = array.get(levelNames, i)

        // Logarithmic calculation
        priceLog = calcLogFibPrice(testLow, testHigh, levelRatio)

        // Linear calculation (for comparison)
        priceLinear = testHigh - ((testHigh - testLow) * levelRatio)

        // Color based on level type
        bgColor =
             levelRatio < 0 ? color.new(color.green, 70) :  // Take profits (negative levels)
             levelRatio == 0 ? color.new(color.orange, 70) : // Entry #1
             levelRatio < 0.7 ? color.new(color.yellow, 70) : // Entry #2, #3
             levelRatio < 0.9 ? color.new(color.red, 70) :   // STOP-LOSS
             color.new(color.blue, 70)                        // Base

        table.cell(testTable, 0, i + 1, levelName, text_color=color.white, bgcolor=bgColor)
        table.cell(testTable, 1, i + 1, str.tostring(levelRatio), text_color=color.white, bgcolor=bgColor)
        table.cell(testTable, 2, i + 1, str.tostring(priceLog, "#.####"), text_color=color.white, bgcolor=bgColor)
        table.cell(testTable, 3, i + 1, str.tostring(priceLinear, "#.####"), text_color=color.white, bgcolor=bgColor)

// Visual representation on chart
// Draw lines at calculated levels
if barstate.islast
    for i = 0 to array.size(levels) - 1
        levelRatio = array.get(levels, i)
        priceLog = calcLogFibPrice(testLow, testHigh, levelRatio)

        if not na(priceLog)
            lineColor =
                 levelRatio < 0 ? color.green :
                 levelRatio == 0 ? color.orange :
                 levelRatio < 0.7 ? color.yellow :
                 levelRatio < 0.9 ? color.red :
                 color.blue

            line.new(bar_index - 50, priceLog, bar_index + 10, priceLog,
                     color=lineColor, width=2, style=line.style_solid)

            label.new(bar_index - 50, priceLog,
                     array.get(levelNames, i) + " (" + str.tostring(levelRatio) + ")",
                     style=label.style_label_right, color=lineColor, textcolor=color.white)

// Notes
// Примечания:
//
// 1. Logarithmic vs Linear comparison shows the difference in calculations
//    Сравнение логарифмической и линейной шкал показывает разницу в вычислениях
//
// 2. For logarithmic scale:
//    Price = exp(log(High) - (log(High) - log(Low)) * level)
//    Для логарифмической шкалы:
//    Цена = exp(log(High) - (log(High) - log(Low)) * уровень)
//
// 3. Level interpretation:
//    - Negative levels (-2.618, -1.618, -0.618): Above High (take profits)
//    - 0.0: Exactly at High (Entry #1)
//    - Positive levels (0.5, 0.618, 0.82, 1.0): Between High and Low
//    - 1.0: Exactly at Low (Base)
