// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TRADERAGENT - SIMPLE TEST VERSION

//@version=6
indicator("Fibonacci Tower (Simple Test)", overlay=true, max_lines_count=500)

// ============================================================================
// SIMPLIFIED TEST VERSION
// This version triggers on EVERY bearish candle for easy testing
// Use this to verify that the drawing mechanism works correctly
// ============================================================================

// Fibonacci Settings
fibLookback = input.int(100, "Fibonacci Lookback Period", minval=10)
showFibLevels = input.bool(true, "Show Fibonacci Levels")
showLabels = input.bool(true, "Show Level Labels")

// ============================================================================
// SIMPLIFIED SIGNAL LOGIC (Just bearish candle)
// ============================================================================

bearishCandle = close < open
buySignal = bearishCandle  // SIMPLIFIED: Triggers on every bearish candle

// ============================================================================
// FIBONACCI LEVELS CALCULATION
// ============================================================================

var float swingHigh = na
var float swingLow = na
var bool fibLevelsActive = false
var int totalBuySignals = 0

// Update swing points when buy signal occurs
if buySignal
    totalBuySignals += 1

    float tempHigh = ta.highest(high, fibLookback)
    float tempLow = ta.lowest(low, fibLookback)

    if not na(tempHigh) and not na(tempLow) and (tempHigh - tempLow) > 0
        swingHigh := tempHigh
        swingLow := tempLow
        fibLevelsActive := true

// Calculate Fibonacci levels safely
fibRange = (not na(swingHigh) and not na(swingLow)) ? swingHigh - swingLow : 0.0
fib0 = not na(swingLow) ? swingLow : close
fib236 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.236 : close
fib382 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.382 : close
fib50 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.500 : close
fib618 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.618 : close
fib786 = not na(swingLow) and fibRange > 0 ? swingLow + fibRange * 0.786 : close
fib100 = not na(swingHigh) ? swingHigh : close

// ============================================================================
// VISUALIZATION
// ============================================================================

// Plot Buy Signals
plotshape(buySignal, title="Test Signal", location=location.belowbar,
    color=color.new(color.lime, 0), style=shape.triangleup, size=size.small, text="TEST")

// Plot Fibonacci Levels
var line fibLine0 = na
var line fibLine236 = na
var line fibLine382 = na
var line fibLine50 = na
var line fibLine618 = na
var line fibLine786 = na
var line fibLine100 = na

var label fibLabel0 = na
var label fibLabel236 = na
var label fibLabel382 = na
var label fibLabel50 = na
var label fibLabel618 = na
var label fibLabel786 = na
var label fibLabel100 = na

if buySignal and showFibLevels and fibLevelsActive and fibRange > 0
    // Delete old lines
    if not na(fibLine0)
        line.delete(fibLine0)
        line.delete(fibLine236)
        line.delete(fibLine382)
        line.delete(fibLine50)
        line.delete(fibLine618)
        line.delete(fibLine786)
        line.delete(fibLine100)

        label.delete(fibLabel0)
        label.delete(fibLabel236)
        label.delete(fibLabel382)
        label.delete(fibLabel50)
        label.delete(fibLabel618)
        label.delete(fibLabel786)
        label.delete(fibLabel100)

    // Draw new Fibonacci lines
    fibLine0 := line.new(bar_index, fib0, bar_index + 1, fib0,
        color=color.new(color.red, 0), width=3, style=line.style_solid, extend=extend.right)
    fibLine236 := line.new(bar_index, fib236, bar_index + 1, fib236,
        color=color.new(color.orange, 0), width=2, style=line.style_solid, extend=extend.right)
    fibLine382 := line.new(bar_index, fib382, bar_index + 1, fib382,
        color=color.new(color.yellow, 0), width=2, style=line.style_solid, extend=extend.right)
    fibLine50 := line.new(bar_index, fib50, bar_index + 1, fib50,
        color=color.new(color.blue, 0), width=4, style=line.style_solid, extend=extend.right)
    fibLine618 := line.new(bar_index, fib618, bar_index + 1, fib618,
        color=color.new(color.green, 0), width=2, style=line.style_solid, extend=extend.right)
    fibLine786 := line.new(bar_index, fib786, bar_index + 1, fib786,
        color=color.new(color.purple, 0), width=2, style=line.style_solid, extend=extend.right)
    fibLine100 := line.new(bar_index, fib100, bar_index + 1, fib100,
        color=color.new(color.red, 0), width=3, style=line.style_solid, extend=extend.right)

    if showLabels
        fibLabel0 := label.new(bar_index, fib0, "0%", style=label.style_label_left,
            color=color.new(color.red, 70), textcolor=color.white, size=size.large)
        fibLabel236 := label.new(bar_index, fib236, "23.6%", style=label.style_label_left,
            color=color.new(color.orange, 70), textcolor=color.white, size=size.large)
        fibLabel382 := label.new(bar_index, fib382, "38.2%", style=label.style_label_left,
            color=color.new(color.yellow, 70), textcolor=color.black, size=size.large)
        fibLabel50 := label.new(bar_index, fib50, "50%", style=label.style_label_left,
            color=color.new(color.blue, 70), textcolor=color.white, size=size.large)
        fibLabel618 := label.new(bar_index, fib618, "61.8%", style=label.style_label_left,
            color=color.new(color.green, 70), textcolor=color.white, size=size.large)
        fibLabel786 := label.new(bar_index, fib786, "78.6%", style=label.style_label_left,
            color=color.new(color.purple, 70), textcolor=color.white, size=size.large)
        fibLabel100 := label.new(bar_index, fib100, "100%", style=label.style_label_left,
            color=color.new(color.red, 70), textcolor=color.white, size=size.large)

// Debug Table
var table debugTable = table.new(position.top_right, 2, 3, border_width=2)

if barstate.islast
    table.cell(debugTable, 0, 0, "TEST VERSION", bgcolor=color.new(color.yellow, 50),
        text_color=color.black, text_size=size.large)
    table.cell(debugTable, 1, 0, "SIMPLIFIED", bgcolor=color.new(color.yellow, 50),
        text_color=color.black, text_size=size.large)

    table.cell(debugTable, 0, 1, "Signals", bgcolor=color.new(color.gray, 70),
        text_color=color.white, text_size=size.normal)
    table.cell(debugTable, 1, 1, str.tostring(totalBuySignals),
        bgcolor=totalBuySignals > 0 ? color.new(color.green, 70) : color.new(color.red, 70),
        text_color=color.white, text_size=size.huge)

    table.cell(debugTable, 0, 2, "Fib Active", bgcolor=color.new(color.gray, 70),
        text_color=color.white, text_size=size.normal)
    table.cell(debugTable, 1, 2, fibLevelsActive ? "YES" : "NO",
        bgcolor=fibLevelsActive ? color.new(color.green, 70) : color.new(color.red, 70),
        text_color=color.white, text_size=size.large)

bgcolor(buySignal ? color.new(color.lime, 90) : na, title="Test Signal Background")
