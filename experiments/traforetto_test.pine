// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
indicator("Traforetto Test - Simplified", overlay=true, max_lines_count=100)

// ============================================================================
// SIMPLIFIED TEST VERSION
// ============================================================================
// Этот упрощенный вариант для тестирования базовых концепций Трафоретто
// Использует более простую логику определения экстремумов

// Настройки
pivotLength = input.int(5, "Pivot Length", minval=1, maxval=20)
showPoints = input.bool(true, "Show Points")

// Определение pivot points
ph = ta.pivothigh(high, pivotLength, pivotLength)
pl = ta.pivotlow(low, pivotLength, pivotLength)

// Массивы для последних 6 экстремумов
var array<float> lastPivotPrices = array.new<float>(0)
var array<int> lastPivotBars = array.new<int>(0)
var array<bool> lastPivotIsHigh = array.new<bool>(0)

// Добавляем новые pivot points
if not na(ph)
    array.unshift(lastPivotPrices, ph)
    array.unshift(lastPivotBars, bar_index - pivotLength)
    array.unshift(lastPivotIsHigh, true)

    // Ограничиваем размер массива
    if array.size(lastPivotPrices) > 6
        array.pop(lastPivotPrices)
        array.pop(lastPivotBars)
        array.pop(lastPivotIsHigh)

if not na(pl)
    array.unshift(lastPivotPrices, pl)
    array.unshift(lastPivotBars, bar_index - pivotLength)
    array.unshift(lastPivotIsHigh, false)

    // Ограничиваем размер массива
    if array.size(lastPivotPrices) > 6
        array.pop(lastPivotPrices)
        array.pop(lastPivotBars)
        array.pop(lastPivotIsHigh)

// Отображение последних pivot points
if showPoints and array.size(lastPivotPrices) > 0
    for i = 0 to math.min(array.size(lastPivotPrices) - 1, 5)
        if i < array.size(lastPivotPrices)
            pivotPrice = array.get(lastPivotPrices, i)
            pivotBar = array.get(lastPivotBars, i)
            isHigh = array.get(lastPivotIsHigh, i)

            label.new(pivotBar, pivotPrice,
                     str.tostring(i + 1),
                     color=color.new(isHigh ? color.red : color.green, 70),
                     textcolor=color.white,
                     style=isHigh ? label.style_label_down : label.style_label_up,
                     size=size.small)

// Информационная таблица
var table testTable = table.new(position.top_right, 2, 3, border_width=1)

if barstate.islast
    table.cell(testTable, 0, 0, "Pivot Points Found",
               bgcolor=color.new(color.gray, 70),
               text_color=color.white)
    table.cell(testTable, 1, 0, str.tostring(array.size(lastPivotPrices)),
               bgcolor=color.new(color.blue, 70),
               text_color=color.white)

    table.cell(testTable, 0, 1, "Last Pivot",
               bgcolor=color.new(color.gray, 70),
               text_color=color.white)
    lastPivotText = array.size(lastPivotPrices) > 0 ?
                    (array.get(lastPivotIsHigh, 0) ? "HIGH" : "LOW") : "N/A"
    table.cell(testTable, 1, 1, lastPivotText,
               bgcolor=color.new(color.gray, 80),
               text_color=color.white)

    table.cell(testTable, 0, 2, "Status",
               bgcolor=color.new(color.gray, 70),
               text_color=color.white)
    statusText = array.size(lastPivotPrices) >= 4 ? "Ready for MR" : "Finding points..."
    table.cell(testTable, 1, 2, statusText,
               bgcolor=array.size(lastPivotPrices) >= 4 ? color.new(color.green, 70) : color.new(color.orange, 70),
               text_color=color.white)

// Визуализация новых pivot points
plotshape(not na(ph), title="Pivot High",
          location=location.abovebar,
          color=color.new(color.red, 0),
          style=shape.triangledown,
          size=size.tiny)

plotshape(not na(pl), title="Pivot Low",
          location=location.belowbar,
          color=color.new(color.green, 0),
          style=shape.triangleup,
          size=size.tiny)
