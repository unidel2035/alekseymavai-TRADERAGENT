// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TRADERAGENT
// Experiment script for testing Enhanced Universal Indicator with Trading Levels

//@version=6
indicator("Universal Indicator Enhanced - Test", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================================================
// TEST CONFIGURATION
// ============================================================================

// Relaxed settings for more frequent signals during testing
rsiLength = input.int(14, "RSI Length", minval=1, group="Test Settings")
rsiOversold = input.int(40, "RSI Oversold Level (Relaxed for Testing)", minval=1, maxval=50, group="Test Settings")
rsiOverbought = input.int(60, "RSI Overbought Level (Relaxed for Testing)", minval=50, maxval=100, group="Test Settings")
volumeThreshold = input.float(1.0, "Volume Threshold (Relaxed)", minval=0.5, step=0.1, group="Test Settings")
fibLookback = input.int(50, "Fibonacci Lookback (Shorter for Testing)", minval=10, group="Test Settings")

// ============================================================================
// SIGNAL DETECTION
// ============================================================================

// RSI calculation
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, 3)

// Volume momentum
volumeMa = ta.sma(volume, 20)
volumeMomentum = volume / volumeMa

// Signals (relaxed conditions for testing)
bullishSignal = ta.crossover(rsi, rsiOversold) and volumeMomentum > volumeThreshold
bearishSignal = ta.crossunder(rsi, rsiOverbought) and volumeMomentum > volumeThreshold

// ============================================================================
// FIBONACCI LEVELS WITH TRADING INFORMATION
// ============================================================================

var line[] testLines = array.new<line>()
var label[] testLabels = array.new<label>()

// Function to clear old drawings
clearDrawings() =>
    if array.size(testLines) > 0
        for i = array.size(testLines) - 1 to 0
            line.delete(array.get(testLines, i))
        array.clear(testLines)
    if array.size(testLabels) > 0
        for i = array.size(testLabels) - 1 to 0
            label.delete(array.get(testLabels, i))
        array.clear(testLabels)

// Draw trading levels for bullish signal
if bullishSignal
    clearDrawings()

    swingLow = ta.lowest(low, fibLookback)
    swingHigh = ta.highest(high, fibLookback)
    fibRange = swingHigh - swingLow

    if fibRange > 0
        // Define logarithmic trading levels
        levels = array.from(1.0, 0.820, 0.618, 0.5, 0.0, -0.618, -1.618, -2.618)
        levelNames = array.from(
             "1.0 Base (Low)",
             "0.82 STOP-LOSS",
             "0.618 Entry #3",
             "0.5 Entry #2",
             "0.0 Entry #1 (High)",
             "-0.618 TP1 (30%)",
             "-1.618 TP2 (30%)",
             "-2.618 TP3 (40%)"
         )
        levelColors = array.from(
             color.blue, color.red, color.orange, color.yellow,
             color.green, color.lime, color.aqua, color.fuchsia
         )

        // Draw each level
        for i = 0 to array.size(levels) - 1
            ratio = array.get(levels, i)
            price = swingLow + fibRange * (1.0 - ratio)
            levelName = array.get(levelNames, i)
            levelColor = array.get(levelColors, i)

            // Draw line
            newLine = line.new(
                 bar_index, price, bar_index + 30, price,
                 color=color.new(levelColor, 30),
                 width=ratio == 0.820 or ratio == 0.0 ? 3 : 2,
                 extend=extend.right,
                 style=ratio == 0.820 or ratio == 0.0 ? line.style_solid : line.style_dashed
             )
            array.push(testLines, newLine)

            // Draw label
            newLabel = label.new(
                 bar_index, price,
                 levelName + "\n" + str.tostring(price, format.mintick),
                 style=label.style_label_left,
                 color=color.new(levelColor, 60),
                 textcolor=color.white,
                 size=size.small
             )
            array.push(testLabels, newLabel)

// Draw trading levels for bearish signal
if bearishSignal
    clearDrawings()

    swingLow = ta.lowest(low, fibLookback)
    swingHigh = ta.highest(high, fibLookback)
    fibRange = swingHigh - swingLow

    if fibRange > 0
        levels = array.from(0.0, 0.180, 0.382, 0.5, 1.0, 1.618, 2.618, 3.618)
        levelNames = array.from(
             "0.0 Base (High)",
             "0.18 STOP-LOSS",
             "0.382 Entry #3",
             "0.5 Entry #2",
             "1.0 Entry #1 (Low)",
             "1.618 TP1 (30%)",
             "2.618 TP2 (30%)",
             "3.618 TP3 (40%)"
         )
        levelColors = array.from(
             color.blue, color.red, color.orange, color.yellow,
             color.green, color.lime, color.aqua, color.fuchsia
         )

        for i = 0 to array.size(levels) - 1
            ratio = array.get(levels, i)
            price = swingHigh - fibRange * ratio
            levelName = array.get(levelNames, i)
            levelColor = array.get(levelColors, i)

            newLine = line.new(
                 bar_index, price, bar_index + 30, price,
                 color=color.new(levelColor, 30),
                 width=ratio == 0.180 or ratio == 1.0 ? 3 : 2,
                 extend=extend.right,
                 style=ratio == 0.180 or ratio == 1.0 ? line.style_solid : line.style_dashed
             )
            array.push(testLines, newLine)

            newLabel = label.new(
                 bar_index, price,
                 levelName + "\n" + str.tostring(price, format.mintick),
                 style=label.style_label_left,
                 color=color.new(levelColor, 60),
                 textcolor=color.white,
                 size=size.small
             )
            array.push(testLabels, newLabel)

// ============================================================================
// SIGNAL MARKERS
// ============================================================================

plotshape(bullishSignal, "LONG Signal", location=location.belowbar,
         color=color.new(color.green, 0), style=shape.triangleup,
         size=size.normal, text="LONG")

plotshape(bearishSignal, "SHORT Signal", location=location.abovebar,
         color=color.new(color.red, 0), style=shape.triangledown,
         size=size.normal, text="SHORT")

// ============================================================================
// TEST STATISTICS TABLE
// ============================================================================

var int totalLongSignals = 0
var int totalShortSignals = 0

if bullishSignal
    totalLongSignals += 1

if bearishSignal
    totalShortSignals += 1

var table statsTable = table.new(position.top_left, 2, 6, border_width=2)

if barstate.islast
    table.cell(statsTable, 0, 0, "ðŸ“Š Test Statistics",
               bgcolor=color.new(color.blue, 70),
               text_color=color.white, text_size=size.normal)
    table.cell(statsTable, 1, 0, "Count",
               bgcolor=color.new(color.blue, 70),
               text_color=color.white, text_size=size.normal)

    table.cell(statsTable, 0, 1, "LONG Signals",
               bgcolor=color.new(color.gray, 85), text_color=color.white)
    table.cell(statsTable, 1, 1, str.tostring(totalLongSignals),
               bgcolor=color.new(color.green, 80), text_color=color.white, text_size=size.large)

    table.cell(statsTable, 0, 2, "SHORT Signals",
               bgcolor=color.new(color.gray, 85), text_color=color.white)
    table.cell(statsTable, 1, 2, str.tostring(totalShortSignals),
               bgcolor=color.new(color.red, 80), text_color=color.white, text_size=size.large)

    table.cell(statsTable, 0, 3, "Current RSI",
               bgcolor=color.new(color.gray, 85), text_color=color.white)
    rsiColor = rsi < rsiOversold ? color.new(color.green, 80) :
               rsi > rsiOverbought ? color.new(color.red, 80) :
               color.new(color.gray, 85)
    table.cell(statsTable, 1, 3, str.tostring(rsi, "#.##"),
               bgcolor=rsiColor, text_color=color.white)

    table.cell(statsTable, 0, 4, "Volume Power",
               bgcolor=color.new(color.gray, 85), text_color=color.white)
    volColor = volumeMomentum > volumeThreshold ? color.new(color.green, 80) : color.new(color.gray, 85)
    table.cell(statsTable, 1, 4, str.tostring(volumeMomentum, "#.##") + "x",
               bgcolor=volColor, text_color=color.white)

    table.cell(statsTable, 0, 5, "Test Mode",
               bgcolor=color.new(color.gray, 85), text_color=color.white)
    table.cell(statsTable, 1, 5, "ACTIVE âœ“",
               bgcolor=color.new(color.orange, 70), text_color=color.white)
