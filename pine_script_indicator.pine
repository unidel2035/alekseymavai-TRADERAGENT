//@version=5
indicator("Pифагор Big Guy Signal Trader", overlay=true, max_labels_count=500)

// ========================================
// ВХОДНЫЕ ПАРАМЕТРЫ
// ========================================

// Настройки риск-менеджмента
riskPercent = input.float(1.0, "Риск на сделку (%)", minval=0.1, maxval=10, step=0.1, group="Риск-менеджмент")
riskRewardRatio = input.float(2.0, "Соотношение риск/прибыль", minval=1, maxval=10, step=0.5, group="Риск-менеджмент")
slPercent = input.float(2.0, "Stop Loss (%)", minval=0.5, maxval=10, step=0.1, group="Риск-менеджмент")

// Настройки отображения
showBuySignals = input.bool(true, "Показать сигналы покупки", group="Отображение")
showSellSignals = input.bool(true, "Показать сигналы продажи", group="Отображение")
showSLTP = input.bool(true, "Показать уровни SL/TP", group="Отображение")

// Настройки алертов
enableAlerts = input.bool(true, "Включить алерты", group="Алерты")
webhookUrl = input.string("", "Webhook URL (оставьте пустым для тестирования)", group="Алерты")

// ========================================
// ЧТЕНИЕ СИГНАЛОВ ОТ ВНЕШНЕГО ИНДИКАТОРА
// ========================================

// Попытка получить данные от индикатора Pифагор Big Guy
// Так как код закрыт, используем примерную логику
// В реальной реализации нужно будет адаптировать под конкретные выходы индикатора

// Эмуляция сигналов на основе технического анализа
// (заменить на реальные данные от Pифагор Big Guy когда будут доступны)

// RSI для определения перекупленности/перепроданности
rsi = ta.rsi(close, 14)
rsiOverbought = rsi > 70
rsiOversold = rsi < 30

// MACD для определения тренда
[macdLine, signalLine, histLine] = ta.macd(close, 12, 26, 9)
macdBullish = ta.crossover(macdLine, signalLine)
macdBearish = ta.crossunder(macdLine, signalLine)

// Bollinger Bands для определения волатильности
[bbMiddle, bbUpper, bbLower] = ta.bb(close, 20, 2)
bbSqueeze = (bbUpper - bbLower) / bbMiddle < 0.1

// EMA для определения направления тренда
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)
uptrend = ema50 > ema200
downtrend = ema50 < ema200

// ========================================
// ГЕНЕРАЦИЯ ТОРГОВЫХ СИГНАЛОВ
// ========================================

// Условия для сигнала покупки
buyCondition = rsiOversold and macdBullish and close > bbLower and uptrend and not bbSqueeze

// Условия для сигнала продажи
sellCondition = rsiOverbought and macdBearish and close < bbUpper and downtrend and not bbSqueeze

// Фильтрация сигналов (не более одного сигнала за N баров)
var int lastBuyBar = 0
var int lastSellBar = 0
minBarsBetweenSignals = 10

validBuySignal = buyCondition and (bar_index - lastBuyBar) > minBarsBetweenSignals
validSellSignal = sellCondition and (bar_index - lastSellBar) > minBarsBetweenSignals

if validBuySignal
    lastBuyBar := bar_index

if validSellSignal
    lastSellBar := bar_index

// ========================================
// РАСЧЕТ УРОВНЕЙ SL И TP
// ========================================

// Расчет уровней для покупки
buyStopLoss = close * (1 - slPercent / 100)
buyTakeProfit = close * (1 + (slPercent * riskRewardRatio) / 100)

// Расчет уровней для продажи
sellStopLoss = close * (1 + slPercent / 100)
sellTakeProfit = close * (1 - (slPercent * riskRewardRatio) / 100)

// ========================================
// ВИЗУАЛИЗАЦИЯ СИГНАЛОВ
// ========================================

// Отображение сигналов покупки
if validBuySignal and showBuySignals
    label.new(bar_index, low, "BUY",
              style=label.style_label_up,
              color=color.green,
              textcolor=color.white,
              size=size.normal)

    if showSLTP
        line.new(bar_index, buyStopLoss, bar_index + 20, buyStopLoss,
                 color=color.red, width=1, style=line.style_dashed)
        line.new(bar_index, buyTakeProfit, bar_index + 20, buyTakeProfit,
                 color=color.green, width=1, style=line.style_dashed)

        label.new(bar_index + 20, buyStopLoss, "SL: " + str.tostring(buyStopLoss, "#.##"),
                  style=label.style_label_left,
                  color=color.red,
                  textcolor=color.white,
                  size=size.small)
        label.new(bar_index + 20, buyTakeProfit, "TP: " + str.tostring(buyTakeProfit, "#.##"),
                  style=label.style_label_left,
                  color=color.green,
                  textcolor=color.white,
                  size=size.small)

// Отображение сигналов продажи
if validSellSignal and showSellSignals
    label.new(bar_index, high, "SELL",
              style=label.style_label_down,
              color=color.red,
              textcolor=color.white,
              size=size.normal)

    if showSLTP
        line.new(bar_index, sellStopLoss, bar_index + 20, sellStopLoss,
                 color=color.red, width=1, style=line.style_dashed)
        line.new(bar_index, sellTakeProfit, bar_index + 20, sellTakeProfit,
                 color=color.green, width=1, style=line.style_dashed)

        label.new(bar_index + 20, sellStopLoss, "SL: " + str.tostring(sellStopLoss, "#.##"),
                  style=label.style_label_left,
                  color=color.red,
                  textcolor=color.white,
                  size=size.small)
        label.new(bar_index + 20, sellTakeProfit, "TP: " + str.tostring(sellTakeProfit, "#.##"),
                  style=label.style_label_left,
                  color=color.green,
                  textcolor=color.white,
                  size=size.small)

// ========================================
// ОТОБРАЖЕНИЕ ИНДИКАТОРОВ
// ========================================

// Отображение EMA
plot(ema50, "EMA 50", color=color.blue, linewidth=2)
plot(ema200, "EMA 200", color=color.purple, linewidth=2)

// Отображение Bollinger Bands
plot(bbUpper, "BB Upper", color=color.gray, linewidth=1)
plot(bbMiddle, "BB Middle", color=color.orange, linewidth=1)
plot(bbLower, "BB Lower", color=color.gray, linewidth=1)

// Заливка Bollinger Bands
fill(plot(bbUpper, display=display.none), plot(bbLower, display=display.none),
     color=color.new(color.gray, 90))

// ========================================
// ГЕНЕРАЦИЯ АЛЕРТОВ
// ========================================

// Функция для создания JSON payload
getAlertJson(action, price, sl, tp) =>
    '{"action":"' + action + '","symbol":"' + syminfo.ticker + '","price":' +
    str.tostring(price) + ',"stop_loss":' + str.tostring(sl) +
    ',"take_profit":' + str.tostring(tp) + ',"risk_percent":' +
    str.tostring(riskPercent) + ',"timestamp":"' + str.tostring(time) + '"}'

// Алерты для сигналов покупки
if validBuySignal and enableAlerts
    alertMessage = getAlertJson("BUY", close, buyStopLoss, buyTakeProfit)
    alert(alertMessage, alert.freq_once_per_bar)

// Алерты для сигналов продажи
if validSellSignal and enableAlerts
    alertMessage = getAlertJson("SELL", close, sellStopLoss, sellTakeProfit)
    alert(alertMessage, alert.freq_once_per_bar)

// ========================================
// ИНФОРМАЦИОННАЯ ПАНЕЛЬ
// ========================================

// Таблица с текущим состоянием
var table infoTable = table.new(position.top_right, 2, 6,
                                 bgcolor=color.new(color.black, 80),
                                 border_width=1)

// Обновление таблицы
if barstate.islast
    table.cell(infoTable, 0, 0, "Параметр", bgcolor=color.gray, text_color=color.white)
    table.cell(infoTable, 1, 0, "Значение", bgcolor=color.gray, text_color=color.white)

    table.cell(infoTable, 0, 1, "RSI", text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(rsi, "#.##"),
               text_color=rsi > 70 ? color.red : rsi < 30 ? color.green : color.white)

    table.cell(infoTable, 0, 2, "Тренд", text_color=color.white)
    table.cell(infoTable, 1, 2, uptrend ? "Восходящий" : downtrend ? "Нисходящий" : "Боковой",
               text_color=uptrend ? color.green : downtrend ? color.red : color.yellow)

    table.cell(infoTable, 0, 3, "MACD", text_color=color.white)
    table.cell(infoTable, 1, 3, macdLine > signalLine ? "Бычий" : "Медвежий",
               text_color=macdLine > signalLine ? color.green : color.red)

    table.cell(infoTable, 0, 4, "BB Squeeze", text_color=color.white)
    table.cell(infoTable, 1, 4, bbSqueeze ? "Да" : "Нет",
               text_color=bbSqueeze ? color.yellow : color.green)

    table.cell(infoTable, 0, 5, "Последний сигнал", text_color=color.white)
    lastSignal = lastBuyBar > lastSellBar ? "BUY" : lastSellBar > lastBuyBar ? "SELL" : "Нет"
    table.cell(infoTable, 1, 5, lastSignal,
               text_color=lastSignal == "BUY" ? color.green : lastSignal == "SELL" ? color.red : color.gray)